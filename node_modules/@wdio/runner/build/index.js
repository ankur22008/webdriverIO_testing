"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _util = _interopRequireDefault(require("util"));

var _events = _interopRequireDefault(require("events"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _config = require("@wdio/config");

var _reporter = _interopRequireDefault(require("./reporter"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('wdio-runner');

class Runner extends _events.default {
  constructor() {
    super();
    this.configParser = new _config.ConfigParser();
    this.sigintWasCalled = false;
  }
  /**
   * run test suite
   * @param  {String}    cid            worker id (e.g. `0-0`)
   * @param  {Object}    argv           cli arguments passed into wdio command
   * @param  {String[]}  specs          list of spec files to run
   * @param  {Object}    caps           capabilties to run session with
   * @param  {String}    configFile     path to config file to get config from
   * @param  {Object}    server         modified WebDriver target
   * @return {Promise}                  resolves in number of failures for testrun
   */


  async run({
    cid,
    argv,
    specs,
    caps,
    configFile,
    server
  }) {
    var _context;

    this.cid = cid;
    this.specs = specs;
    this.caps = caps;
    /**
     * add config file
     */

    this.configParser.addConfigFile(configFile);
    /**
     * merge cli arguments into config
     */

    this.configParser.merge(argv);
    /**
     * merge host/port changes by service launcher into config
     */

    this.configParser.merge(server);
    this.config = this.configParser.getConfig();
    (0, _utils.initialiseServices)(this.config, caps).map((_context = this.configParser).addService.bind(_context));
    this.reporter = new _reporter.default(this.config, this.cid);
    this.inWatchMode = Boolean(this.config.watch);
    await (0, _utils.runHook)('beforeSession', this.config, this.caps, this.specs);
    const browser = await this._initSession(this.config, this.caps);
    /**
     * return if session initialisation failed
     */

    if (!browser) {
      return this._shutdown(1);
    }

    const isMultiremote = Boolean(browser.isMultiremote);
    /**
     * kill session of SIGINT signal showed up while trying to
     * get a session ID
     */

    if (this.sigintWasCalled) {
      log.info('SIGINT signal detected while starting session, shutting down...');
      await this.endSession();
      return this._shutdown(0);
    }
    /**
     * initialise framework
     */


    this.framework = (0, _config.initialisePlugin)(this.config.framework, 'framework');
    /**
     * initialisation successful, send start message
     */

    this.reporter.emit('runner:start', {
      cid,
      specs,
      config: this.config,
      isMultiremote,
      sessionId: browser.sessionId,
      capabilities: isMultiremote ? browser.instances.reduce((caps, browserName) => {
        caps[browserName] = browser[browserName].capabilities;
        return caps;
      }, {}) : browser.options.capabilities
    });
    /**
     * report sessionId and target connection information to worker
     */

    const {
      protocol,
      hostname,
      port,
      path,
      queryParams
    } = browser.options;
    const {
      isW3C,
      sessionId
    } = browser;
    process.send({
      origin: 'worker',
      name: 'sessionStarted',
      content: {
        sessionId,
        isW3C,
        protocol,
        hostname,
        port,
        path,
        queryParams
      }
    });
    /**
     * kick off tests in framework
     */

    let failures = 0;

    try {
      failures = failures = await this.framework.run(cid, this.config, specs, caps, this.reporter);
      await this._fetchDriverLogs(this.config);
    } catch (e) {
      log.error(e);
      this.emit('error', e);
      failures = 1;
    }
    /**
     * in watch mode we don't close the session and open a blank page instead
     */


    if (!argv.watch) {
      await this.endSession();
    } else {
      await global.browser.url('about:blank');
    }

    this.reporter.emit('runner:end', {
      failures,
      cid: this.cid
    });
    await this._shutdown(failures);
    return failures;
  }
  /**
   * init WebDriver session
   * @param  {object}  config        configuration of sessions
   * @param  {Object}  caps          desired cabilities of session
   * @return {Promise}               resolves with browser object or null if session couldn't get established
   */


  async _initSession(config, caps) {
    let browser = null;

    try {
      browser = global.browser = global.driver = await (0, _utils.initialiseInstance)(config, caps, this.isMultiremote);
    } catch (e) {
      log.error(e);
      this.emit('error', e);
      return browser;
    }

    browser.config = config;
    /**
     * register global helper method to fetch elements
     */

    global.$ = selector => browser.$(selector);

    global.$$ = selector => browser.$$(selector);
    /**
     * register command event
     */


    browser.on('command', command => this.reporter.emit('client:beforeCommand', Object.assign(command, {
      sessionId: browser.sessionId
    })));
    /**
     * register result event
     */

    browser.on('result', result => this.reporter.emit('client:afterCommand', Object.assign(result, {
      sessionId: browser.sessionId
    })));
    return browser;
  }
  /**
   * fetch logs provided by browser driver
   */


  async _fetchDriverLogs(config) {
    /**
     * only fetch logs if
     */
    if (
    /**
     * a log directory is given in config
     */
    !config.logDir ||
    /**
     * the session wasn't killed during start up phase
     */
    !global.browser.sessionId ||
    /**
     * driver supports it
     */
    typeof global.browser.getLogs === 'undefined') {
      return;
    }

    const logTypes = await global.browser.getLogTypes();
    log.debug(`Fetching logs for ${logTypes.join(', ')}`);
    return Promise.all(logTypes.map(async logType => {
      const logs = await global.browser.getLogs(logType);
      /**
       * don't write to file if no logs were captured
       */

      if (logs.length === 0) {
        return;
      }

      const stringLogs = logs.map(log => JSON.stringify(log)).join('\n');
      return _util.default.promisify(_fs.default.writeFile)(_path.default.join(config.logDir, `wdio-${this.cid}-${logType}.log`), stringLogs, 'utf-8');
    }));
  }
  /**
   * kill worker session
   */


  async _shutdown(failures) {
    await this.reporter.waitForSync();
    this.emit('exit', failures === 0 ? 0 : 1);
  }
  /**
   * end WebDriver session, a config object can be applied if object has changed
   * within a hook by the user
   */


  async endSession(shutdown) {
    /**
     * don't do anything if test framework returns after SIGINT
     * if endSession is called without shutdown flag we expect a session id
     */
    if (!shutdown && (!global.browser || !global.browser.sessionId)) {
      return;
    }
    /**
     * if shutdown was called but no session was created, wait until it was
     * and try to end it
     */


    if (shutdown && (!global.browser || !global.browser.sessionId)) {
      await new Promise(resolve => setTimeout(resolve, 250));
      return this.endSession(shutdown);
    }

    await global.browser.deleteSession();
    delete global.browser.sessionId;
    await (0, _utils.runHook)('afterSession', global.browser.config, this.caps, this.specs);

    if (shutdown) {
      await this._shutdown();
    }
  }

}

exports.default = Runner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJsb2ciLCJSdW5uZXIiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsImNvbmZpZ1BhcnNlciIsIkNvbmZpZ1BhcnNlciIsInNpZ2ludFdhc0NhbGxlZCIsInJ1biIsImNpZCIsImFyZ3YiLCJzcGVjcyIsImNhcHMiLCJjb25maWdGaWxlIiwic2VydmVyIiwiYWRkQ29uZmlnRmlsZSIsIm1lcmdlIiwiY29uZmlnIiwiZ2V0Q29uZmlnIiwibWFwIiwiYWRkU2VydmljZSIsInJlcG9ydGVyIiwiQmFzZVJlcG9ydGVyIiwiaW5XYXRjaE1vZGUiLCJCb29sZWFuIiwid2F0Y2giLCJicm93c2VyIiwiX2luaXRTZXNzaW9uIiwiX3NodXRkb3duIiwiaXNNdWx0aXJlbW90ZSIsImluZm8iLCJlbmRTZXNzaW9uIiwiZnJhbWV3b3JrIiwiZW1pdCIsInNlc3Npb25JZCIsImNhcGFiaWxpdGllcyIsImluc3RhbmNlcyIsInJlZHVjZSIsImJyb3dzZXJOYW1lIiwib3B0aW9ucyIsInByb3RvY29sIiwiaG9zdG5hbWUiLCJwb3J0IiwicGF0aCIsInF1ZXJ5UGFyYW1zIiwiaXNXM0MiLCJwcm9jZXNzIiwic2VuZCIsIm9yaWdpbiIsIm5hbWUiLCJjb250ZW50IiwiZmFpbHVyZXMiLCJfZmV0Y2hEcml2ZXJMb2dzIiwiZSIsImVycm9yIiwiZ2xvYmFsIiwidXJsIiwiZHJpdmVyIiwiJCIsInNlbGVjdG9yIiwiJCQiLCJvbiIsImNvbW1hbmQiLCJPYmplY3QiLCJhc3NpZ24iLCJyZXN1bHQiLCJsb2dEaXIiLCJnZXRMb2dzIiwibG9nVHlwZXMiLCJnZXRMb2dUeXBlcyIsImRlYnVnIiwiam9pbiIsIlByb21pc2UiLCJhbGwiLCJsb2dUeXBlIiwibG9ncyIsImxlbmd0aCIsInN0cmluZ0xvZ3MiLCJKU09OIiwic3RyaW5naWZ5IiwidXRpbCIsInByb21pc2lmeSIsImZzIiwid3JpdGVGaWxlIiwid2FpdEZvclN5bmMiLCJzaHV0ZG93biIsInJlc29sdmUiLCJzZXRUaW1lb3V0IiwiZGVsZXRlU2Vzc2lvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxHQUFHLEdBQUcscUJBQU8sYUFBUCxDQUFaOztBQUVlLE1BQU1DLE1BQU4sU0FBcUJDLGVBQXJCLENBQWtDO0FBQzdDQyxFQUFBQSxXQUFXLEdBQUk7QUFDWDtBQUNBLFNBQUtDLFlBQUwsR0FBb0IsSUFBSUMsb0JBQUosRUFBcEI7QUFDQSxTQUFLQyxlQUFMLEdBQXVCLEtBQXZCO0FBQ0g7QUFFRDs7Ozs7Ozs7Ozs7O0FBVUEsUUFBTUMsR0FBTixDQUFXO0FBQUVDLElBQUFBLEdBQUY7QUFBT0MsSUFBQUEsSUFBUDtBQUFhQyxJQUFBQSxLQUFiO0FBQW9CQyxJQUFBQSxJQUFwQjtBQUEwQkMsSUFBQUEsVUFBMUI7QUFBc0NDLElBQUFBO0FBQXRDLEdBQVgsRUFBMkQ7QUFBQTs7QUFDdkQsU0FBS0wsR0FBTCxHQUFXQSxHQUFYO0FBQ0EsU0FBS0UsS0FBTCxHQUFhQSxLQUFiO0FBQ0EsU0FBS0MsSUFBTCxHQUFZQSxJQUFaO0FBRUE7Ozs7QUFHQSxTQUFLUCxZQUFMLENBQWtCVSxhQUFsQixDQUFnQ0YsVUFBaEM7QUFFQTs7OztBQUdBLFNBQUtSLFlBQUwsQ0FBa0JXLEtBQWxCLENBQXdCTixJQUF4QjtBQUVBOzs7O0FBR0EsU0FBS0wsWUFBTCxDQUFrQlcsS0FBbEIsQ0FBd0JGLE1BQXhCO0FBRUEsU0FBS0csTUFBTCxHQUFjLEtBQUtaLFlBQUwsQ0FBa0JhLFNBQWxCLEVBQWQ7QUFDQSxtQ0FBbUIsS0FBS0QsTUFBeEIsRUFBZ0NMLElBQWhDLEVBQXNDTyxHQUF0QyxDQUE0QyxpQkFBS2QsWUFBTCxFQUFrQmUsVUFBOUQ7QUFFQSxTQUFLQyxRQUFMLEdBQWdCLElBQUlDLGlCQUFKLENBQWlCLEtBQUtMLE1BQXRCLEVBQThCLEtBQUtSLEdBQW5DLENBQWhCO0FBQ0EsU0FBS2MsV0FBTCxHQUFtQkMsT0FBTyxDQUFDLEtBQUtQLE1BQUwsQ0FBWVEsS0FBYixDQUExQjtBQUVBLFVBQU0sb0JBQVEsZUFBUixFQUF5QixLQUFLUixNQUE5QixFQUFzQyxLQUFLTCxJQUEzQyxFQUFpRCxLQUFLRCxLQUF0RCxDQUFOO0FBQ0EsVUFBTWUsT0FBTyxHQUFHLE1BQU0sS0FBS0MsWUFBTCxDQUFrQixLQUFLVixNQUF2QixFQUErQixLQUFLTCxJQUFwQyxDQUF0QjtBQUVBOzs7O0FBR0EsUUFBSSxDQUFDYyxPQUFMLEVBQWM7QUFDVixhQUFPLEtBQUtFLFNBQUwsQ0FBZSxDQUFmLENBQVA7QUFDSDs7QUFFRCxVQUFNQyxhQUFhLEdBQUdMLE9BQU8sQ0FBQ0UsT0FBTyxDQUFDRyxhQUFULENBQTdCO0FBRUE7Ozs7O0FBSUEsUUFBSSxLQUFLdEIsZUFBVCxFQUEwQjtBQUN0Qk4sTUFBQUEsR0FBRyxDQUFDNkIsSUFBSixDQUFTLGlFQUFUO0FBQ0EsWUFBTSxLQUFLQyxVQUFMLEVBQU47QUFDQSxhQUFPLEtBQUtILFNBQUwsQ0FBZSxDQUFmLENBQVA7QUFDSDtBQUVEOzs7OztBQUdBLFNBQUtJLFNBQUwsR0FBaUIsOEJBQWlCLEtBQUtmLE1BQUwsQ0FBWWUsU0FBN0IsRUFBd0MsV0FBeEMsQ0FBakI7QUFFQTs7OztBQUdBLFNBQUtYLFFBQUwsQ0FBY1ksSUFBZCxDQUFtQixjQUFuQixFQUFtQztBQUMvQnhCLE1BQUFBLEdBRCtCO0FBRS9CRSxNQUFBQSxLQUYrQjtBQUcvQk0sTUFBQUEsTUFBTSxFQUFFLEtBQUtBLE1BSGtCO0FBSS9CWSxNQUFBQSxhQUorQjtBQUsvQkssTUFBQUEsU0FBUyxFQUFFUixPQUFPLENBQUNRLFNBTFk7QUFNL0JDLE1BQUFBLFlBQVksRUFBRU4sYUFBYSxHQUNyQkgsT0FBTyxDQUFDVSxTQUFSLENBQWtCQyxNQUFsQixDQUF5QixDQUFDekIsSUFBRCxFQUFPMEIsV0FBUCxLQUF1QjtBQUM5QzFCLFFBQUFBLElBQUksQ0FBQzBCLFdBQUQsQ0FBSixHQUFvQlosT0FBTyxDQUFDWSxXQUFELENBQVAsQ0FBcUJILFlBQXpDO0FBQ0EsZUFBT3ZCLElBQVA7QUFDSCxPQUhDLEVBR0MsRUFIRCxDQURxQixHQUtyQmMsT0FBTyxDQUFDYSxPQUFSLENBQWdCSjtBQVhTLEtBQW5DO0FBY0E7Ozs7QUFHQSxVQUFNO0FBQUVLLE1BQUFBLFFBQUY7QUFBWUMsTUFBQUEsUUFBWjtBQUFzQkMsTUFBQUEsSUFBdEI7QUFBNEJDLE1BQUFBLElBQTVCO0FBQWtDQyxNQUFBQTtBQUFsQyxRQUFrRGxCLE9BQU8sQ0FBQ2EsT0FBaEU7QUFDQSxVQUFNO0FBQUVNLE1BQUFBLEtBQUY7QUFBU1gsTUFBQUE7QUFBVCxRQUF1QlIsT0FBN0I7QUFDQW9CLElBQUFBLE9BQU8sQ0FBQ0MsSUFBUixDQUFhO0FBQ1RDLE1BQUFBLE1BQU0sRUFBRSxRQURDO0FBRVRDLE1BQUFBLElBQUksRUFBRSxnQkFGRztBQUdUQyxNQUFBQSxPQUFPLEVBQUU7QUFBRWhCLFFBQUFBLFNBQUY7QUFBYVcsUUFBQUEsS0FBYjtBQUFvQkwsUUFBQUEsUUFBcEI7QUFBOEJDLFFBQUFBLFFBQTlCO0FBQXdDQyxRQUFBQSxJQUF4QztBQUE4Q0MsUUFBQUEsSUFBOUM7QUFBb0RDLFFBQUFBO0FBQXBEO0FBSEEsS0FBYjtBQU1BOzs7O0FBR0EsUUFBSU8sUUFBUSxHQUFHLENBQWY7O0FBQ0EsUUFBSTtBQUNBQSxNQUFBQSxRQUFRLEdBQUdBLFFBQVEsR0FBRyxNQUFNLEtBQUtuQixTQUFMLENBQWV4QixHQUFmLENBQW1CQyxHQUFuQixFQUF3QixLQUFLUSxNQUE3QixFQUFxQ04sS0FBckMsRUFBNENDLElBQTVDLEVBQWtELEtBQUtTLFFBQXZELENBQTVCO0FBQ0EsWUFBTSxLQUFLK0IsZ0JBQUwsQ0FBc0IsS0FBS25DLE1BQTNCLENBQU47QUFDSCxLQUhELENBR0UsT0FBT29DLENBQVAsRUFBVTtBQUNScEQsTUFBQUEsR0FBRyxDQUFDcUQsS0FBSixDQUFVRCxDQUFWO0FBQ0EsV0FBS3BCLElBQUwsQ0FBVSxPQUFWLEVBQW1Cb0IsQ0FBbkI7QUFDQUYsTUFBQUEsUUFBUSxHQUFHLENBQVg7QUFDSDtBQUVEOzs7OztBQUdBLFFBQUksQ0FBQ3pDLElBQUksQ0FBQ2UsS0FBVixFQUFpQjtBQUNiLFlBQU0sS0FBS00sVUFBTCxFQUFOO0FBQ0gsS0FGRCxNQUVPO0FBQ0gsWUFBTXdCLE1BQU0sQ0FBQzdCLE9BQVAsQ0FBZThCLEdBQWYsQ0FBbUIsYUFBbkIsQ0FBTjtBQUNIOztBQUVELFNBQUtuQyxRQUFMLENBQWNZLElBQWQsQ0FBbUIsWUFBbkIsRUFBaUM7QUFDN0JrQixNQUFBQSxRQUQ2QjtBQUU3QjFDLE1BQUFBLEdBQUcsRUFBRSxLQUFLQTtBQUZtQixLQUFqQztBQUtBLFVBQU0sS0FBS21CLFNBQUwsQ0FBZXVCLFFBQWYsQ0FBTjtBQUNBLFdBQU9BLFFBQVA7QUFDSDtBQUVEOzs7Ozs7OztBQU1BLFFBQU14QixZQUFOLENBQW9CVixNQUFwQixFQUE0QkwsSUFBNUIsRUFBa0M7QUFDOUIsUUFBSWMsT0FBTyxHQUFHLElBQWQ7O0FBRUEsUUFBSTtBQUNBQSxNQUFBQSxPQUFPLEdBQUc2QixNQUFNLENBQUM3QixPQUFQLEdBQWlCNkIsTUFBTSxDQUFDRSxNQUFQLEdBQWdCLE1BQU0sK0JBQW1CeEMsTUFBbkIsRUFBMkJMLElBQTNCLEVBQWlDLEtBQUtpQixhQUF0QyxDQUFqRDtBQUNILEtBRkQsQ0FFRSxPQUFPd0IsQ0FBUCxFQUFVO0FBQ1JwRCxNQUFBQSxHQUFHLENBQUNxRCxLQUFKLENBQVVELENBQVY7QUFDQSxXQUFLcEIsSUFBTCxDQUFVLE9BQVYsRUFBbUJvQixDQUFuQjtBQUNBLGFBQU8zQixPQUFQO0FBQ0g7O0FBRURBLElBQUFBLE9BQU8sQ0FBQ1QsTUFBUixHQUFpQkEsTUFBakI7QUFFQTs7OztBQUdBc0MsSUFBQUEsTUFBTSxDQUFDRyxDQUFQLEdBQVlDLFFBQUQsSUFBY2pDLE9BQU8sQ0FBQ2dDLENBQVIsQ0FBVUMsUUFBVixDQUF6Qjs7QUFDQUosSUFBQUEsTUFBTSxDQUFDSyxFQUFQLEdBQWFELFFBQUQsSUFBY2pDLE9BQU8sQ0FBQ2tDLEVBQVIsQ0FBV0QsUUFBWCxDQUExQjtBQUVBOzs7OztBQUdBakMsSUFBQUEsT0FBTyxDQUFDbUMsRUFBUixDQUFXLFNBQVgsRUFBdUJDLE9BQUQsSUFBYSxLQUFLekMsUUFBTCxDQUFjWSxJQUFkLENBQy9CLHNCQUQrQixFQUUvQjhCLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjRixPQUFkLEVBQXVCO0FBQUU1QixNQUFBQSxTQUFTLEVBQUVSLE9BQU8sQ0FBQ1E7QUFBckIsS0FBdkIsQ0FGK0IsQ0FBbkM7QUFLQTs7OztBQUdBUixJQUFBQSxPQUFPLENBQUNtQyxFQUFSLENBQVcsUUFBWCxFQUFzQkksTUFBRCxJQUFZLEtBQUs1QyxRQUFMLENBQWNZLElBQWQsQ0FDN0IscUJBRDZCLEVBRTdCOEIsTUFBTSxDQUFDQyxNQUFQLENBQWNDLE1BQWQsRUFBc0I7QUFBRS9CLE1BQUFBLFNBQVMsRUFBRVIsT0FBTyxDQUFDUTtBQUFyQixLQUF0QixDQUY2QixDQUFqQztBQUtBLFdBQU9SLE9BQVA7QUFDSDtBQUVEOzs7OztBQUdBLFFBQU0wQixnQkFBTixDQUF3Qm5DLE1BQXhCLEVBQWdDO0FBQzVCOzs7QUFHQTtBQUNJOzs7QUFHQSxLQUFDQSxNQUFNLENBQUNpRCxNQUFSO0FBQ0E7OztBQUdBLEtBQUNYLE1BQU0sQ0FBQzdCLE9BQVAsQ0FBZVEsU0FKaEI7QUFLQTs7O0FBR0EsV0FBT3FCLE1BQU0sQ0FBQzdCLE9BQVAsQ0FBZXlDLE9BQXRCLEtBQWtDLFdBWnRDLEVBYUU7QUFDRTtBQUNIOztBQUVELFVBQU1DLFFBQVEsR0FBRyxNQUFNYixNQUFNLENBQUM3QixPQUFQLENBQWUyQyxXQUFmLEVBQXZCO0FBQ0FwRSxJQUFBQSxHQUFHLENBQUNxRSxLQUFKLENBQVcscUJBQW9CRixRQUFRLENBQUNHLElBQVQsQ0FBYyxJQUFkLENBQW9CLEVBQW5EO0FBQ0EsV0FBT0MsT0FBTyxDQUFDQyxHQUFSLENBQVlMLFFBQVEsQ0FBQ2pELEdBQVQsQ0FBYSxNQUFPdUQsT0FBUCxJQUFtQjtBQUMvQyxZQUFNQyxJQUFJLEdBQUcsTUFBTXBCLE1BQU0sQ0FBQzdCLE9BQVAsQ0FBZXlDLE9BQWYsQ0FBdUJPLE9BQXZCLENBQW5CO0FBRUE7Ozs7QUFHQSxVQUFJQyxJQUFJLENBQUNDLE1BQUwsS0FBZ0IsQ0FBcEIsRUFBdUI7QUFDbkI7QUFDSDs7QUFFRCxZQUFNQyxVQUFVLEdBQUdGLElBQUksQ0FBQ3hELEdBQUwsQ0FBVWxCLEdBQUQsSUFBUzZFLElBQUksQ0FBQ0MsU0FBTCxDQUFlOUUsR0FBZixDQUFsQixFQUF1Q3NFLElBQXZDLENBQTRDLElBQTVDLENBQW5CO0FBQ0EsYUFBT1MsY0FBS0MsU0FBTCxDQUFlQyxZQUFHQyxTQUFsQixFQUNIeEMsY0FBSzRCLElBQUwsQ0FBVXRELE1BQU0sQ0FBQ2lELE1BQWpCLEVBQTBCLFFBQU8sS0FBS3pELEdBQUksSUFBR2lFLE9BQVEsTUFBckQsQ0FERyxFQUVIRyxVQUZHLEVBR0gsT0FIRyxDQUFQO0FBS0gsS0FoQmtCLENBQVosQ0FBUDtBQWlCSDtBQUVEOzs7OztBQUdBLFFBQU1qRCxTQUFOLENBQWlCdUIsUUFBakIsRUFBMkI7QUFDdkIsVUFBTSxLQUFLOUIsUUFBTCxDQUFjK0QsV0FBZCxFQUFOO0FBQ0EsU0FBS25ELElBQUwsQ0FBVSxNQUFWLEVBQWtCa0IsUUFBUSxLQUFLLENBQWIsR0FBaUIsQ0FBakIsR0FBcUIsQ0FBdkM7QUFDSDtBQUVEOzs7Ozs7QUFJQSxRQUFNcEIsVUFBTixDQUFrQnNELFFBQWxCLEVBQTRCO0FBQ3hCOzs7O0FBSUEsUUFBSSxDQUFDQSxRQUFELEtBQWMsQ0FBQzlCLE1BQU0sQ0FBQzdCLE9BQVIsSUFBbUIsQ0FBQzZCLE1BQU0sQ0FBQzdCLE9BQVAsQ0FBZVEsU0FBakQsQ0FBSixFQUFpRTtBQUM3RDtBQUNIO0FBRUQ7Ozs7OztBQUlBLFFBQUltRCxRQUFRLEtBQUssQ0FBQzlCLE1BQU0sQ0FBQzdCLE9BQVIsSUFBbUIsQ0FBQzZCLE1BQU0sQ0FBQzdCLE9BQVAsQ0FBZVEsU0FBeEMsQ0FBWixFQUFnRTtBQUM1RCxZQUFNLElBQUlzQyxPQUFKLENBQWFjLE9BQUQsSUFBYUMsVUFBVSxDQUFDRCxPQUFELEVBQVUsR0FBVixDQUFuQyxDQUFOO0FBQ0EsYUFBTyxLQUFLdkQsVUFBTCxDQUFnQnNELFFBQWhCLENBQVA7QUFDSDs7QUFFRCxVQUFNOUIsTUFBTSxDQUFDN0IsT0FBUCxDQUFlOEQsYUFBZixFQUFOO0FBQ0EsV0FBT2pDLE1BQU0sQ0FBQzdCLE9BQVAsQ0FBZVEsU0FBdEI7QUFFQSxVQUFNLG9CQUFRLGNBQVIsRUFBd0JxQixNQUFNLENBQUM3QixPQUFQLENBQWVULE1BQXZDLEVBQStDLEtBQUtMLElBQXBELEVBQTBELEtBQUtELEtBQS9ELENBQU47O0FBRUEsUUFBSTBFLFFBQUosRUFBYztBQUNWLFlBQU0sS0FBS3pELFNBQUwsRUFBTjtBQUNIO0FBQ0o7O0FBaFE0QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcydcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgdXRpbCBmcm9tICd1dGlsJ1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnXG5cbmltcG9ydCBsb2dnZXIgZnJvbSAnQHdkaW8vbG9nZ2VyJ1xuaW1wb3J0IHsgQ29uZmlnUGFyc2VyLCBpbml0aWFsaXNlUGx1Z2luIH0gZnJvbSAnQHdkaW8vY29uZmlnJ1xuXG5pbXBvcnQgQmFzZVJlcG9ydGVyIGZyb20gJy4vcmVwb3J0ZXInXG5pbXBvcnQgeyBydW5Ib29rLCBpbml0aWFsaXNlU2VydmljZXMsIGluaXRpYWxpc2VJbnN0YW5jZSB9IGZyb20gJy4vdXRpbHMnXG5cbmNvbnN0IGxvZyA9IGxvZ2dlcignd2Rpby1ydW5uZXInKVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSdW5uZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGNvbnN0cnVjdG9yICgpIHtcbiAgICAgICAgc3VwZXIoKVxuICAgICAgICB0aGlzLmNvbmZpZ1BhcnNlciA9IG5ldyBDb25maWdQYXJzZXIoKVxuICAgICAgICB0aGlzLnNpZ2ludFdhc0NhbGxlZCA9IGZhbHNlXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogcnVuIHRlc3Qgc3VpdGVcbiAgICAgKiBAcGFyYW0gIHtTdHJpbmd9ICAgIGNpZCAgICAgICAgICAgIHdvcmtlciBpZCAoZS5nLiBgMC0wYClcbiAgICAgKiBAcGFyYW0gIHtPYmplY3R9ICAgIGFyZ3YgICAgICAgICAgIGNsaSBhcmd1bWVudHMgcGFzc2VkIGludG8gd2RpbyBjb21tYW5kXG4gICAgICogQHBhcmFtICB7U3RyaW5nW119ICBzcGVjcyAgICAgICAgICBsaXN0IG9mIHNwZWMgZmlsZXMgdG8gcnVuXG4gICAgICogQHBhcmFtICB7T2JqZWN0fSAgICBjYXBzICAgICAgICAgICBjYXBhYmlsdGllcyB0byBydW4gc2Vzc2lvbiB3aXRoXG4gICAgICogQHBhcmFtICB7U3RyaW5nfSAgICBjb25maWdGaWxlICAgICBwYXRoIHRvIGNvbmZpZyBmaWxlIHRvIGdldCBjb25maWcgZnJvbVxuICAgICAqIEBwYXJhbSAge09iamVjdH0gICAgc2VydmVyICAgICAgICAgbW9kaWZpZWQgV2ViRHJpdmVyIHRhcmdldFxuICAgICAqIEByZXR1cm4ge1Byb21pc2V9ICAgICAgICAgICAgICAgICAgcmVzb2x2ZXMgaW4gbnVtYmVyIG9mIGZhaWx1cmVzIGZvciB0ZXN0cnVuXG4gICAgICovXG4gICAgYXN5bmMgcnVuICh7IGNpZCwgYXJndiwgc3BlY3MsIGNhcHMsIGNvbmZpZ0ZpbGUsIHNlcnZlciB9KSB7XG4gICAgICAgIHRoaXMuY2lkID0gY2lkXG4gICAgICAgIHRoaXMuc3BlY3MgPSBzcGVjc1xuICAgICAgICB0aGlzLmNhcHMgPSBjYXBzXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGFkZCBjb25maWcgZmlsZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5jb25maWdQYXJzZXIuYWRkQ29uZmlnRmlsZShjb25maWdGaWxlKVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBtZXJnZSBjbGkgYXJndW1lbnRzIGludG8gY29uZmlnXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmNvbmZpZ1BhcnNlci5tZXJnZShhcmd2KVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBtZXJnZSBob3N0L3BvcnQgY2hhbmdlcyBieSBzZXJ2aWNlIGxhdW5jaGVyIGludG8gY29uZmlnXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmNvbmZpZ1BhcnNlci5tZXJnZShzZXJ2ZXIpXG5cbiAgICAgICAgdGhpcy5jb25maWcgPSB0aGlzLmNvbmZpZ1BhcnNlci5nZXRDb25maWcoKVxuICAgICAgICBpbml0aWFsaXNlU2VydmljZXModGhpcy5jb25maWcsIGNhcHMpLm1hcCg6OnRoaXMuY29uZmlnUGFyc2VyLmFkZFNlcnZpY2UpXG5cbiAgICAgICAgdGhpcy5yZXBvcnRlciA9IG5ldyBCYXNlUmVwb3J0ZXIodGhpcy5jb25maWcsIHRoaXMuY2lkKVxuICAgICAgICB0aGlzLmluV2F0Y2hNb2RlID0gQm9vbGVhbih0aGlzLmNvbmZpZy53YXRjaClcblxuICAgICAgICBhd2FpdCBydW5Ib29rKCdiZWZvcmVTZXNzaW9uJywgdGhpcy5jb25maWcsIHRoaXMuY2FwcywgdGhpcy5zcGVjcylcbiAgICAgICAgY29uc3QgYnJvd3NlciA9IGF3YWl0IHRoaXMuX2luaXRTZXNzaW9uKHRoaXMuY29uZmlnLCB0aGlzLmNhcHMpXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHJldHVybiBpZiBzZXNzaW9uIGluaXRpYWxpc2F0aW9uIGZhaWxlZFxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKCFicm93c2VyKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fc2h1dGRvd24oMSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGlzTXVsdGlyZW1vdGUgPSBCb29sZWFuKGJyb3dzZXIuaXNNdWx0aXJlbW90ZSlcblxuICAgICAgICAvKipcbiAgICAgICAgICoga2lsbCBzZXNzaW9uIG9mIFNJR0lOVCBzaWduYWwgc2hvd2VkIHVwIHdoaWxlIHRyeWluZyB0b1xuICAgICAgICAgKiBnZXQgYSBzZXNzaW9uIElEXG4gICAgICAgICAqL1xuICAgICAgICBpZiAodGhpcy5zaWdpbnRXYXNDYWxsZWQpIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKCdTSUdJTlQgc2lnbmFsIGRldGVjdGVkIHdoaWxlIHN0YXJ0aW5nIHNlc3Npb24sIHNodXR0aW5nIGRvd24uLi4nKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5lbmRTZXNzaW9uKClcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zaHV0ZG93bigwKVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGluaXRpYWxpc2UgZnJhbWV3b3JrXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmZyYW1ld29yayA9IGluaXRpYWxpc2VQbHVnaW4odGhpcy5jb25maWcuZnJhbWV3b3JrLCAnZnJhbWV3b3JrJylcblxuICAgICAgICAvKipcbiAgICAgICAgICogaW5pdGlhbGlzYXRpb24gc3VjY2Vzc2Z1bCwgc2VuZCBzdGFydCBtZXNzYWdlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnJlcG9ydGVyLmVtaXQoJ3J1bm5lcjpzdGFydCcsIHtcbiAgICAgICAgICAgIGNpZCxcbiAgICAgICAgICAgIHNwZWNzLFxuICAgICAgICAgICAgY29uZmlnOiB0aGlzLmNvbmZpZyxcbiAgICAgICAgICAgIGlzTXVsdGlyZW1vdGUsXG4gICAgICAgICAgICBzZXNzaW9uSWQ6IGJyb3dzZXIuc2Vzc2lvbklkLFxuICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiBpc011bHRpcmVtb3RlXG4gICAgICAgICAgICAgICAgPyBicm93c2VyLmluc3RhbmNlcy5yZWR1Y2UoKGNhcHMsIGJyb3dzZXJOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNhcHNbYnJvd3Nlck5hbWVdID0gYnJvd3Nlclticm93c2VyTmFtZV0uY2FwYWJpbGl0aWVzXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjYXBzXG4gICAgICAgICAgICAgICAgfSwge30pXG4gICAgICAgICAgICAgICAgOiBicm93c2VyLm9wdGlvbnMuY2FwYWJpbGl0aWVzXG4gICAgICAgIH0pXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHJlcG9ydCBzZXNzaW9uSWQgYW5kIHRhcmdldCBjb25uZWN0aW9uIGluZm9ybWF0aW9uIHRvIHdvcmtlclxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgeyBwcm90b2NvbCwgaG9zdG5hbWUsIHBvcnQsIHBhdGgsIHF1ZXJ5UGFyYW1zIH0gPSBicm93c2VyLm9wdGlvbnNcbiAgICAgICAgY29uc3QgeyBpc1czQywgc2Vzc2lvbklkIH0gPSBicm93c2VyXG4gICAgICAgIHByb2Nlc3Muc2VuZCh7XG4gICAgICAgICAgICBvcmlnaW46ICd3b3JrZXInLFxuICAgICAgICAgICAgbmFtZTogJ3Nlc3Npb25TdGFydGVkJyxcbiAgICAgICAgICAgIGNvbnRlbnQ6IHsgc2Vzc2lvbklkLCBpc1czQywgcHJvdG9jb2wsIGhvc3RuYW1lLCBwb3J0LCBwYXRoLCBxdWVyeVBhcmFtcyB9XG4gICAgICAgIH0pXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGtpY2sgb2ZmIHRlc3RzIGluIGZyYW1ld29ya1xuICAgICAgICAgKi9cbiAgICAgICAgbGV0IGZhaWx1cmVzID0gMFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZmFpbHVyZXMgPSBmYWlsdXJlcyA9IGF3YWl0IHRoaXMuZnJhbWV3b3JrLnJ1bihjaWQsIHRoaXMuY29uZmlnLCBzcGVjcywgY2FwcywgdGhpcy5yZXBvcnRlcilcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2ZldGNoRHJpdmVyTG9ncyh0aGlzLmNvbmZpZylcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgbG9nLmVycm9yKGUpXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZSlcbiAgICAgICAgICAgIGZhaWx1cmVzID0gMVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGluIHdhdGNoIG1vZGUgd2UgZG9uJ3QgY2xvc2UgdGhlIHNlc3Npb24gYW5kIG9wZW4gYSBibGFuayBwYWdlIGluc3RlYWRcbiAgICAgICAgICovXG4gICAgICAgIGlmICghYXJndi53YXRjaCkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5lbmRTZXNzaW9uKClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGF3YWl0IGdsb2JhbC5icm93c2VyLnVybCgnYWJvdXQ6YmxhbmsnKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5yZXBvcnRlci5lbWl0KCdydW5uZXI6ZW5kJywge1xuICAgICAgICAgICAgZmFpbHVyZXMsXG4gICAgICAgICAgICBjaWQ6IHRoaXMuY2lkXG4gICAgICAgIH0pXG5cbiAgICAgICAgYXdhaXQgdGhpcy5fc2h1dGRvd24oZmFpbHVyZXMpXG4gICAgICAgIHJldHVybiBmYWlsdXJlc1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGluaXQgV2ViRHJpdmVyIHNlc3Npb25cbiAgICAgKiBAcGFyYW0gIHtvYmplY3R9ICBjb25maWcgICAgICAgIGNvbmZpZ3VyYXRpb24gb2Ygc2Vzc2lvbnNcbiAgICAgKiBAcGFyYW0gIHtPYmplY3R9ICBjYXBzICAgICAgICAgIGRlc2lyZWQgY2FiaWxpdGllcyBvZiBzZXNzaW9uXG4gICAgICogQHJldHVybiB7UHJvbWlzZX0gICAgICAgICAgICAgICByZXNvbHZlcyB3aXRoIGJyb3dzZXIgb2JqZWN0IG9yIG51bGwgaWYgc2Vzc2lvbiBjb3VsZG4ndCBnZXQgZXN0YWJsaXNoZWRcbiAgICAgKi9cbiAgICBhc3luYyBfaW5pdFNlc3Npb24gKGNvbmZpZywgY2Fwcykge1xuICAgICAgICBsZXQgYnJvd3NlciA9IG51bGxcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYnJvd3NlciA9IGdsb2JhbC5icm93c2VyID0gZ2xvYmFsLmRyaXZlciA9IGF3YWl0IGluaXRpYWxpc2VJbnN0YW5jZShjb25maWcsIGNhcHMsIHRoaXMuaXNNdWx0aXJlbW90ZSlcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgbG9nLmVycm9yKGUpXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZSlcbiAgICAgICAgICAgIHJldHVybiBicm93c2VyXG4gICAgICAgIH1cblxuICAgICAgICBicm93c2VyLmNvbmZpZyA9IGNvbmZpZ1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiByZWdpc3RlciBnbG9iYWwgaGVscGVyIG1ldGhvZCB0byBmZXRjaCBlbGVtZW50c1xuICAgICAgICAgKi9cbiAgICAgICAgZ2xvYmFsLiQgPSAoc2VsZWN0b3IpID0+IGJyb3dzZXIuJChzZWxlY3RvcilcbiAgICAgICAgZ2xvYmFsLiQkID0gKHNlbGVjdG9yKSA9PiBicm93c2VyLiQkKHNlbGVjdG9yKVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiByZWdpc3RlciBjb21tYW5kIGV2ZW50XG4gICAgICAgICAqL1xuICAgICAgICBicm93c2VyLm9uKCdjb21tYW5kJywgKGNvbW1hbmQpID0+IHRoaXMucmVwb3J0ZXIuZW1pdChcbiAgICAgICAgICAgICdjbGllbnQ6YmVmb3JlQ29tbWFuZCcsXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGNvbW1hbmQsIHsgc2Vzc2lvbklkOiBicm93c2VyLnNlc3Npb25JZCB9KVxuICAgICAgICApKVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiByZWdpc3RlciByZXN1bHQgZXZlbnRcbiAgICAgICAgICovXG4gICAgICAgIGJyb3dzZXIub24oJ3Jlc3VsdCcsIChyZXN1bHQpID0+IHRoaXMucmVwb3J0ZXIuZW1pdChcbiAgICAgICAgICAgICdjbGllbnQ6YWZ0ZXJDb21tYW5kJyxcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ocmVzdWx0LCB7IHNlc3Npb25JZDogYnJvd3Nlci5zZXNzaW9uSWQgfSlcbiAgICAgICAgKSlcblxuICAgICAgICByZXR1cm4gYnJvd3NlclxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGZldGNoIGxvZ3MgcHJvdmlkZWQgYnkgYnJvd3NlciBkcml2ZXJcbiAgICAgKi9cbiAgICBhc3luYyBfZmV0Y2hEcml2ZXJMb2dzIChjb25maWcpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIG9ubHkgZmV0Y2ggbG9ncyBpZlxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBhIGxvZyBkaXJlY3RvcnkgaXMgZ2l2ZW4gaW4gY29uZmlnXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICFjb25maWcubG9nRGlyIHx8XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIHRoZSBzZXNzaW9uIHdhc24ndCBraWxsZWQgZHVyaW5nIHN0YXJ0IHVwIHBoYXNlXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICFnbG9iYWwuYnJvd3Nlci5zZXNzaW9uSWQgfHxcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogZHJpdmVyIHN1cHBvcnRzIGl0XG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIHR5cGVvZiBnbG9iYWwuYnJvd3Nlci5nZXRMb2dzID09PSAndW5kZWZpbmVkJ1xuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbG9nVHlwZXMgPSBhd2FpdCBnbG9iYWwuYnJvd3Nlci5nZXRMb2dUeXBlcygpXG4gICAgICAgIGxvZy5kZWJ1ZyhgRmV0Y2hpbmcgbG9ncyBmb3IgJHtsb2dUeXBlcy5qb2luKCcsICcpfWApXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChsb2dUeXBlcy5tYXAoYXN5bmMgKGxvZ1R5cGUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGxvZ3MgPSBhd2FpdCBnbG9iYWwuYnJvd3Nlci5nZXRMb2dzKGxvZ1R5cGUpXG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogZG9uJ3Qgd3JpdGUgdG8gZmlsZSBpZiBubyBsb2dzIHdlcmUgY2FwdHVyZWRcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKGxvZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHN0cmluZ0xvZ3MgPSBsb2dzLm1hcCgobG9nKSA9PiBKU09OLnN0cmluZ2lmeShsb2cpKS5qb2luKCdcXG4nKVxuICAgICAgICAgICAgcmV0dXJuIHV0aWwucHJvbWlzaWZ5KGZzLndyaXRlRmlsZSkoXG4gICAgICAgICAgICAgICAgcGF0aC5qb2luKGNvbmZpZy5sb2dEaXIsIGB3ZGlvLSR7dGhpcy5jaWR9LSR7bG9nVHlwZX0ubG9nYCksXG4gICAgICAgICAgICAgICAgc3RyaW5nTG9ncyxcbiAgICAgICAgICAgICAgICAndXRmLTgnXG4gICAgICAgICAgICApXG4gICAgICAgIH0pKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGtpbGwgd29ya2VyIHNlc3Npb25cbiAgICAgKi9cbiAgICBhc3luYyBfc2h1dGRvd24gKGZhaWx1cmVzKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucmVwb3J0ZXIud2FpdEZvclN5bmMoKVxuICAgICAgICB0aGlzLmVtaXQoJ2V4aXQnLCBmYWlsdXJlcyA9PT0gMCA/IDAgOiAxKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGVuZCBXZWJEcml2ZXIgc2Vzc2lvbiwgYSBjb25maWcgb2JqZWN0IGNhbiBiZSBhcHBsaWVkIGlmIG9iamVjdCBoYXMgY2hhbmdlZFxuICAgICAqIHdpdGhpbiBhIGhvb2sgYnkgdGhlIHVzZXJcbiAgICAgKi9cbiAgICBhc3luYyBlbmRTZXNzaW9uIChzaHV0ZG93bikge1xuICAgICAgICAvKipcbiAgICAgICAgICogZG9uJ3QgZG8gYW55dGhpbmcgaWYgdGVzdCBmcmFtZXdvcmsgcmV0dXJucyBhZnRlciBTSUdJTlRcbiAgICAgICAgICogaWYgZW5kU2Vzc2lvbiBpcyBjYWxsZWQgd2l0aG91dCBzaHV0ZG93biBmbGFnIHdlIGV4cGVjdCBhIHNlc3Npb24gaWRcbiAgICAgICAgICovXG4gICAgICAgIGlmICghc2h1dGRvd24gJiYgKCFnbG9iYWwuYnJvd3NlciB8fCAhZ2xvYmFsLmJyb3dzZXIuc2Vzc2lvbklkKSkge1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogaWYgc2h1dGRvd24gd2FzIGNhbGxlZCBidXQgbm8gc2Vzc2lvbiB3YXMgY3JlYXRlZCwgd2FpdCB1bnRpbCBpdCB3YXNcbiAgICAgICAgICogYW5kIHRyeSB0byBlbmQgaXRcbiAgICAgICAgICovXG4gICAgICAgIGlmIChzaHV0ZG93biAmJiAoIWdsb2JhbC5icm93c2VyIHx8ICFnbG9iYWwuYnJvd3Nlci5zZXNzaW9uSWQpKSB7XG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAyNTApKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5kU2Vzc2lvbihzaHV0ZG93bilcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IGdsb2JhbC5icm93c2VyLmRlbGV0ZVNlc3Npb24oKVxuICAgICAgICBkZWxldGUgZ2xvYmFsLmJyb3dzZXIuc2Vzc2lvbklkXG5cbiAgICAgICAgYXdhaXQgcnVuSG9vaygnYWZ0ZXJTZXNzaW9uJywgZ2xvYmFsLmJyb3dzZXIuY29uZmlnLCB0aGlzLmNhcHMsIHRoaXMuc3BlY3MpXG5cbiAgICAgICAgaWYgKHNodXRkb3duKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9zaHV0ZG93bigpXG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=