"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _reporter = _interopRequireDefault(require("@wdio/reporter"));

var _chalk = _interopRequireDefault(require("chalk"));

var _prettyMs = _interopRequireDefault(require("pretty-ms"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class SpecReporter extends _reporter.default {
  constructor(options) {
    /**
     * make spec reporter to write to output stream by default
     */
    options = Object.assign({
      stdout: true
    }, options);
    super(options); // Keep track of the order that suites were called

    this.suiteUids = [];
    this.suites = [];
    this.indents = 0;
    this.suiteIndents = {};
    this.defaultTestIndent = '   ';
    this.stateCounts = {
      passed: 0,
      failed: 0,
      skipped: 0
    };
    this.chalk = _chalk.default;
  }

  onSuiteStart(suite) {
    this.suiteUids.push(suite.uid);
    this.suiteIndents[suite.uid] = ++this.indents;
  }

  onSuiteEnd(suite) {
    this.indents--;
    this.suites.push(suite);
  }

  onHookEnd(hook) {
    if (hook.error) {
      this.stateCounts.failed++;
    }
  }

  onTestPass() {
    this.stateCounts.passed++;
  }

  onTestFail() {
    this.stateCounts.failed++;
  }

  onTestSkip() {
    this.stateCounts.skipped++;
  }

  onRunnerEnd(runner) {
    this.printReport(runner);
  }
  /**
   * Print the report to the screen
   */


  printReport(runner) {
    const duration = `(${(0, _prettyMs.default)(runner._duration)})`;
    const preface = `[${this.getEnviromentCombo(runner.capabilities, false, runner.isMultiremote).trim()} #${runner.cid}]`;
    const divider = '------------------------------------------------------------------'; // Get the results

    const results = this.getResultDisplay(); // If there are no test results then return nothing

    if (results.length === 0) {
      return;
    }

    const output = [...this.getHeaderDisplay(runner), ...results, ...this.getCountDisplay(duration), ...this.getFailureDisplay()]; // Prefix all values with the browser information

    const prefacedOutput = output.map(value => {
      return value ? `${preface} ${value}` : preface;
    }); // Output the results

    this.write(`${divider}\n${prefacedOutput.join('\n')}\n`);
  }
  /**
   * Get the header display for the report
   * @param  {Object} runner Runner data
   * @return {Array}         Header data
   */


  getHeaderDisplay(runner) {
    const combo = this.getEnviromentCombo(runner.capabilities).trim(); // Spec file name and enviroment information

    const output = [`Spec: ${runner.specs[0]}`, `Running: ${combo}`, ''];
    return output;
  }
  /**
   * returns everything worth reporting from a suite
   * @param  {Object}    suite  test suite containing tests and hooks
   * @return {Object[]}         list of events to report
   */


  getEventsToReport(suite) {
    return [
    /**
     * report all tests
     */
    ...suite.tests,
    /**
     * and only hooks that failed
     */
    ...suite.hooks.filter(hook => Boolean(hook.error))];
  }
  /**
   * Get the results from the tests
   * @param  {Array} suites Runner suites
   * @return {Array}        Display output list
   */


  getResultDisplay() {
    const output = [];
    const suites = this.getOrderedSuites();

    for (const suite of suites) {
      // Don't do anything if a suite has no tests or sub suites
      if (suite.tests.length === 0 && suite.suites.length === 0 && suite.hooks.length === 0) {
        continue;
      } // Get the indent/starting point for this suite


      const suiteIndent = this.indent(suite.uid); // Display the title of the suite

      output.push(`${suiteIndent}${suite.title}`);
      const eventsToReport = this.getEventsToReport(suite);

      for (const test of eventsToReport) {
        const test_title = test.title;
        const state = test.state;
        const test_indent = `${this.defaultTestIndent}${suiteIndent}`; // Output for a single test

        output.push(`${test_indent}${this.chalk[this.getColor(state)](this.getSymbol(state))} ${test_title}`);
      } // Put a line break after each suite (only if tests exist in that suite)


      if (eventsToReport.length) {
        output.push('');
      }
    }

    return output;
  }
  /**
   * Get the display for passing, failing and skipped
   * @param  {String} duration Duration string
   * @return {Array} Count display
   */


  getCountDisplay(duration) {
    const output = []; // Get the passes

    if (this.stateCounts.passed > 0) {
      const text = `${this.stateCounts.passed} passing ${duration}`;
      output.push(this.chalk[this.getColor('passed')](text));
      duration = '';
    } // Get the failures


    if (this.stateCounts.failed > 0) {
      const text = `${this.stateCounts.failed} failing ${duration}`.trim();
      output.push(this.chalk[this.getColor('failed')](text));
      duration = '';
    } // Get the skipped tests


    if (this.stateCounts.skipped > 0) {
      const text = `${this.stateCounts.skipped} skipped ${duration}`.trim();
      output.push(this.chalk[this.getColor('skipped')](text));
    }

    return output;
  }
  /**
   * Get display for failed tests, e.g. stack trace
   * @return {Array} Stack trace output
   */


  getFailureDisplay() {
    let failureLength = 0;
    const output = [];
    const suites = this.getOrderedSuites();

    for (const suite of suites) {
      const suiteTitle = suite.title;
      const eventsToReport = this.getEventsToReport(suite);

      for (const test of eventsToReport) {
        if (test.state !== 'failed') {
          continue;
        }

        const testTitle = test.title; // If we get here then there is a failed test

        output.push('', `${++failureLength}) ${suiteTitle} ${testTitle}`, this.chalk.red(test.error.message), ...test.error.stack.split(/\n/g).map(value => this.chalk.gray(value)));
      }
    }

    return output;
  }
  /**
   * Get suites in the order they were called
   * @return {Array} Ordered suites
   */


  getOrderedSuites() {
    if (this.orderedSuites) {
      return this.orderedSuites;
    }

    this.orderedSuites = [];

    for (const uid of this.suiteUids) {
      for (const suite of this.suites) {
        if (suite.uid !== uid) {
          continue;
        }

        this.orderedSuites.push(suite);
      }
    }

    return this.orderedSuites;
  }
  /**
   * Indent a suite based on where how it's nested
   * @param  {String} uid Unique suite key
   * @return {String}     Spaces for indentation
   */


  indent(uid) {
    const indents = this.suiteIndents[uid];
    return indents === 0 ? '' : Array(indents).join('    ');
  }
  /**
   * Get a symbol based on state
   * @param  {String} state State of a test
   * @return {String}       Symbol to display
   */


  getSymbol(state) {
    let symbol = '?'; // in case of an unknown state

    switch (state) {
      case 'passed':
        symbol = '✓';
        break;

      case 'skipped':
        symbol = '-';
        break;

      case 'failed':
        symbol = '✖';
        break;
    }

    return symbol;
  }
  /**
   * Get a color based on a given state
   * @param  {String} state Test state
   * @return {String}       State color
   */


  getColor(state) {
    // In case of an unknown state
    let color = null;

    switch (state) {
      case 'passed':
        color = 'green';
        break;

      case 'pending':
      case 'skipped':
        color = 'cyan';
        break;

      case 'failed':
        color = 'red';
        break;
    }

    return color;
  }
  /**
   * Get information about the enviroment
   * @param  {Object}  caps    Enviroment details
   * @param  {Boolean} verbose
   * @return {String}          Enviroment string
   */


  getEnviromentCombo(caps, verbose = true, isMultiremote = false) {
    const device = caps.deviceName;
    const browser = isMultiremote ? 'MultiremoteBrowser' : caps.browserName || caps.browser;
    const version = caps.version || caps.platformVersion || caps.browser_version;
    const platform = caps.os ? caps.os + ' ' + caps.os_version : caps.platform || caps.platformName; // Mobile capabilities

    if (device) {
      const program = (caps.app || '').replace('sauce-storage:', '') || caps.browserName;
      const executing = program ? `executing ${program}` : '';

      if (!verbose) {
        return `${device} ${platform} ${version}`;
      }

      return `${device} on ${platform} ${version} ${executing}`.trim();
    }

    if (!verbose) {
      return (browser + ' ' + (version || '') + ' ' + (platform || '')).trim();
    }

    return browser + (version ? ` (v${version})` : '') + (platform ? ` on ${platform}` : '');
  }

}

var _default = SpecReporter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJTcGVjUmVwb3J0ZXIiLCJXRElPUmVwb3J0ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdGlvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJzdGRvdXQiLCJzdWl0ZVVpZHMiLCJzdWl0ZXMiLCJpbmRlbnRzIiwic3VpdGVJbmRlbnRzIiwiZGVmYXVsdFRlc3RJbmRlbnQiLCJzdGF0ZUNvdW50cyIsInBhc3NlZCIsImZhaWxlZCIsInNraXBwZWQiLCJjaGFsayIsIm9uU3VpdGVTdGFydCIsInN1aXRlIiwicHVzaCIsInVpZCIsIm9uU3VpdGVFbmQiLCJvbkhvb2tFbmQiLCJob29rIiwiZXJyb3IiLCJvblRlc3RQYXNzIiwib25UZXN0RmFpbCIsIm9uVGVzdFNraXAiLCJvblJ1bm5lckVuZCIsInJ1bm5lciIsInByaW50UmVwb3J0IiwiZHVyYXRpb24iLCJfZHVyYXRpb24iLCJwcmVmYWNlIiwiZ2V0RW52aXJvbWVudENvbWJvIiwiY2FwYWJpbGl0aWVzIiwiaXNNdWx0aXJlbW90ZSIsInRyaW0iLCJjaWQiLCJkaXZpZGVyIiwicmVzdWx0cyIsImdldFJlc3VsdERpc3BsYXkiLCJsZW5ndGgiLCJvdXRwdXQiLCJnZXRIZWFkZXJEaXNwbGF5IiwiZ2V0Q291bnREaXNwbGF5IiwiZ2V0RmFpbHVyZURpc3BsYXkiLCJwcmVmYWNlZE91dHB1dCIsIm1hcCIsInZhbHVlIiwid3JpdGUiLCJqb2luIiwiY29tYm8iLCJzcGVjcyIsImdldEV2ZW50c1RvUmVwb3J0IiwidGVzdHMiLCJob29rcyIsImZpbHRlciIsIkJvb2xlYW4iLCJnZXRPcmRlcmVkU3VpdGVzIiwic3VpdGVJbmRlbnQiLCJpbmRlbnQiLCJ0aXRsZSIsImV2ZW50c1RvUmVwb3J0IiwidGVzdCIsInRlc3RfdGl0bGUiLCJzdGF0ZSIsInRlc3RfaW5kZW50IiwiZ2V0Q29sb3IiLCJnZXRTeW1ib2wiLCJ0ZXh0IiwiZmFpbHVyZUxlbmd0aCIsInN1aXRlVGl0bGUiLCJ0ZXN0VGl0bGUiLCJyZWQiLCJtZXNzYWdlIiwic3RhY2siLCJzcGxpdCIsImdyYXkiLCJvcmRlcmVkU3VpdGVzIiwiQXJyYXkiLCJzeW1ib2wiLCJjb2xvciIsImNhcHMiLCJ2ZXJib3NlIiwiZGV2aWNlIiwiZGV2aWNlTmFtZSIsImJyb3dzZXIiLCJicm93c2VyTmFtZSIsInZlcnNpb24iLCJwbGF0Zm9ybVZlcnNpb24iLCJicm93c2VyX3ZlcnNpb24iLCJwbGF0Zm9ybSIsIm9zIiwib3NfdmVyc2lvbiIsInBsYXRmb3JtTmFtZSIsInByb2dyYW0iLCJhcHAiLCJyZXBsYWNlIiwiZXhlY3V0aW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLFlBQU4sU0FBMkJDLGlCQUEzQixDQUF3QztBQUNwQ0MsRUFBQUEsV0FBVyxDQUFFQyxPQUFGLEVBQVc7QUFDbEI7OztBQUdBQSxJQUFBQSxPQUFPLEdBQUdDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjO0FBQUVDLE1BQUFBLE1BQU0sRUFBRTtBQUFWLEtBQWQsRUFBZ0NILE9BQWhDLENBQVY7QUFDQSxVQUFNQSxPQUFOLEVBTGtCLENBT2xCOztBQUNBLFNBQUtJLFNBQUwsR0FBaUIsRUFBakI7QUFFQSxTQUFLQyxNQUFMLEdBQWMsRUFBZDtBQUNBLFNBQUtDLE9BQUwsR0FBZSxDQUFmO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQixFQUFwQjtBQUNBLFNBQUtDLGlCQUFMLEdBQXlCLEtBQXpCO0FBQ0EsU0FBS0MsV0FBTCxHQUFtQjtBQUNmQyxNQUFBQSxNQUFNLEVBQUcsQ0FETTtBQUVmQyxNQUFBQSxNQUFNLEVBQUcsQ0FGTTtBQUdmQyxNQUFBQSxPQUFPLEVBQUc7QUFISyxLQUFuQjtBQU1BLFNBQUtDLEtBQUwsR0FBYUEsY0FBYjtBQUNIOztBQUVEQyxFQUFBQSxZQUFZLENBQUVDLEtBQUYsRUFBUztBQUNqQixTQUFLWCxTQUFMLENBQWVZLElBQWYsQ0FBb0JELEtBQUssQ0FBQ0UsR0FBMUI7QUFDQSxTQUFLVixZ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TyxRQUFTLElBQUdILE9BQVEsSUFBR1UsU0FBVSxFQUFqRCxDQUFtRDlELElBQW5ELEVBQVA7QUFDSDs7QUFFRCxRQUFJLENBQUMrQyxPQUFMLEVBQWM7QUFDVixhQUFPLENBQUNHLE9BQU8sR0FBRyxHQUFWLElBQWlCRSxPQUFPLElBQUksRUFBNUIsSUFBa0MsR0FBbEMsSUFBeUNHLFFBQVEsSUFBSSxFQUFyRCxDQUFELEVBQTJEdkQsSUFBM0QsRUFBUDtBQUNIOztBQUVELFdBQU9rRCxPQUFPLElBQUlFLE9BQU8sR0FBSSxNQUFLQSxPQUFRLEdBQWpCLEdBQXNCLEVBQWpDLENBQVAsSUFBK0NHLFFBQVEsR0FBSSxPQUFNQSxRQUFTLEVBQW5CLEdBQXVCLEVBQTlFLENBQVA7QUFDSDs7QUFsVm1DOztlQXFWekI1RixZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFdESU9SZXBvcnRlciBmcm9tICdAd2Rpby9yZXBvcnRlcidcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsaydcbmltcG9ydCBwcmV0dHlNcyBmcm9tICdwcmV0dHktbXMnXG5cbmNsYXNzIFNwZWNSZXBvcnRlciBleHRlbmRzIFdESU9SZXBvcnRlciB7XG4gICAgY29uc3RydWN0b3IgKG9wdGlvbnMpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIG1ha2Ugc3BlYyByZXBvcnRlciB0byB3cml0ZSB0byBvdXRwdXQgc3RyZWFtIGJ5IGRlZmF1bHRcbiAgICAgICAgICovXG4gICAgICAgIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHsgc3Rkb3V0OiB0cnVlIH0sIG9wdGlvbnMpXG4gICAgICAgIHN1cGVyKG9wdGlvbnMpXG5cbiAgICAgICAgLy8gS2VlcCB0cmFjayBvZiB0aGUgb3JkZXIgdGhhdCBzdWl0ZXMgd2VyZSBjYWxsZWRcbiAgICAgICAgdGhpcy5zdWl0ZVVpZHMgPSBbXVxuXG4gICAgICAgIHRoaXMuc3VpdGVzID0gW11cbiAgICAgICAgdGhpcy5pbmRlbnRzID0gMFxuICAgICAgICB0aGlzLnN1aXRlSW5kZW50cyA9IHt9XG4gICAgICAgIHRoaXMuZGVmYXVsdFRlc3RJbmRlbnQgPSAnICAgJ1xuICAgICAgICB0aGlzLnN0YXRlQ291bnRzID0ge1xuICAgICAgICAgICAgcGFzc2VkIDogMCxcbiAgICAgICAgICAgIGZhaWxlZCA6IDAsXG4gICAgICAgICAgICBza2lwcGVkIDogMFxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jaGFsayA9IGNoYWxrXG4gICAgfVxuXG4gICAgb25TdWl0ZVN0YXJ0IChzdWl0ZSkge1xuICAgICAgICB0aGlzLnN1aXRlVWlkcy5wdXNoKHN1aXRlLnVpZClcbiAgICAgICAgdGhpcy5zdWl0ZUluZGVudHNbc3VpdGUudWlkXSA9ICsrdGhpcy5pbmRlbnRzXG4gICAgfVxuXG4gICAgb25TdWl0ZUVuZCAoc3VpdGUpIHtcbiAgICAgICAgdGhpcy5pbmRlbnRzLS1cbiAgICAgICAgdGhpcy5zdWl0ZXMucHVzaChzdWl0ZSlcbiAgICB9XG5cbiAgICBvbkhvb2tFbmQgKGhvb2spIHtcbiAgICAgICAgaWYgKGhvb2suZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGVDb3VudHMuZmFpbGVkKytcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uVGVzdFBhc3MgKCkge1xuICAgICAgICB0aGlzLnN0YXRlQ291bnRzLnBhc3NlZCsrXG4gICAgfVxuXG4gICAgb25UZXN0RmFpbCAoKSB7XG4gICAgICAgIHRoaXMuc3RhdGVDb3VudHMuZmFpbGVkKytcbiAgICB9XG5cbiAgICBvblRlc3RTa2lwICgpIHtcbiAgICAgICAgdGhpcy5zdGF0ZUNvdW50cy5za2lwcGVkKytcbiAgICB9XG5cbiAgICBvblJ1bm5lckVuZCAocnVubmVyKSB7XG4gICAgICAgIHRoaXMucHJpbnRSZXBvcnQocnVubmVyKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFByaW50IHRoZSByZXBvcnQgdG8gdGhlIHNjcmVlblxuICAgICAqL1xuICAgIHByaW50UmVwb3J0KHJ1bm5lcikge1xuICAgICAgICBjb25zdCBkdXJhdGlvbiA9IGAoJHtwcmV0dHlNcyhydW5uZXIuX2R1cmF0aW9uKX0pYFxuICAgICAgICBjb25zdCBwcmVmYWNlID0gYFske3RoaXMuZ2V0RW52aXJvbWVudENvbWJvKHJ1bm5lci5jYXBhYmlsaXRpZXMsIGZhbHNlLCBydW5uZXIuaXNNdWx0aXJlbW90ZSkudHJpbSgpfSAjJHtydW5uZXIuY2lkfV1gXG4gICAgICAgIGNvbnN0IGRpdmlkZXIgPSAnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJ1xuXG4gICAgICAgIC8vIEdldCB0aGUgcmVzdWx0c1xuICAgICAgICBjb25zdCByZXN1bHRzID0gdGhpcy5nZXRSZXN1bHREaXNwbGF5KClcblxuICAgICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gdGVzdCByZXN1bHRzIHRoZW4gcmV0dXJuIG5vdGhpbmdcbiAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG91dHB1dCA9IFtcbiAgICAgICAgICAgIC4uLnRoaXMuZ2V0SGVhZGVyRGlzcGxheShydW5uZXIpLFxuICAgICAgICAgICAgLi4ucmVzdWx0cyxcbiAgICAgICAgICAgIC4uLnRoaXMuZ2V0Q291bnREaXNwbGF5KGR1cmF0aW9uKSxcbiAgICAgICAgICAgIC4uLnRoaXMuZ2V0RmFpbHVyZURpc3BsYXkoKSxcbiAgICAgICAgXVxuXG4gICAgICAgIC8vIFByZWZpeCBhbGwgdmFsdWVzIHdpdGggdGhlIGJyb3dzZXIgaW5mb3JtYXRpb25cbiAgICAgICAgY29uc3QgcHJlZmFjZWRPdXRwdXQgPSBvdXRwdXQubWFwKCh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlID8gYCR7cHJlZmFjZX0gJHt2YWx1ZX1gIDogcHJlZmFjZVxuICAgICAgICB9KVxuXG4gICAgICAgIC8vIE91dHB1dCB0aGUgcmVzdWx0c1xuICAgICAgICB0aGlzLndyaXRlKGAke2RpdmlkZXJ9XFxuJHtwcmVmYWNlZE91dHB1dC5qb2luKCdcXG4nKX1cXG5gKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgaGVhZGVyIGRpc3BsYXkgZm9yIHRoZSByZXBvcnRcbiAgICAgKiBAcGFyYW0gIHtPYmplY3R9IHJ1bm5lciBSdW5uZXIgZGF0YVxuICAgICAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgIEhlYWRlciBkYXRhXG4gICAgICovXG4gICAgZ2V0SGVhZGVyRGlzcGxheShydW5uZXIpIHtcbiAgICAgICAgY29uc3QgY29tYm8gPSB0aGlzLmdldEVudmlyb21lbnRDb21ibyhydW5uZXIuY2FwYWJpbGl0aWVzKS50cmltKClcblxuICAgICAgICAvLyBTcGVjIGZpbGUgbmFtZSBhbmQgZW52aXJvbWVudCBpbmZvcm1hdGlvblxuICAgICAgICBjb25zdCBvdXRwdXQgPSBbXG4gICAgICAgICAgICBgU3BlYzogJHtydW5uZXIuc3BlY3NbMF19YCxcbiAgICAgICAgICAgIGBSdW5uaW5nOiAke2NvbWJvfWAsXG4gICAgICAgICAgICAnJyxcbiAgICAgICAgXVxuXG4gICAgICAgIHJldHVybiBvdXRwdXRcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiByZXR1cm5zIGV2ZXJ5dGhpbmcgd29ydGggcmVwb3J0aW5nIGZyb20gYSBzdWl0ZVxuICAgICAqIEBwYXJhbSAge09iamVjdH0gICAgc3VpdGUgIHRlc3Qgc3VpdGUgY29udGFpbmluZyB0ZXN0cyBhbmQgaG9va3NcbiAgICAgKiBAcmV0dXJuIHtPYmplY3RbXX0gICAgICAgICBsaXN0IG9mIGV2ZW50cyB0byByZXBvcnRcbiAgICAgKi9cbiAgICBnZXRFdmVudHNUb1JlcG9ydCAoc3VpdGUpIHtcbiAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogcmVwb3J0IGFsbCB0ZXN0c1xuICAgICAgICAgICAgICovXG4gICAgICAgICAgICAuLi5zdWl0ZS50ZXN0cyxcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogYW5kIG9ubHkgaG9va3MgdGhhdCBmYWlsZWRcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgLi4uc3VpdGUuaG9va3NcbiAgICAgICAgICAgICAgICAuZmlsdGVyKChob29rKSA9PiBCb29sZWFuKGhvb2suZXJyb3IpKVxuICAgICAgICBdXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSByZXN1bHRzIGZyb20gdGhlIHRlc3RzXG4gICAgICogQHBhcmFtICB7QXJyYXl9IHN1aXRlcyBSdW5uZXIgc3VpdGVzXG4gICAgICogQHJldHVybiB7QXJyYXl9ICAgICAgICBEaXNwbGF5IG91dHB1dCBsaXN0XG4gICAgICovXG4gICAgZ2V0UmVzdWx0RGlzcGxheSAoKSB7XG4gICAgICAgIGNvbnN0IG91dHB1dCA9IFtdXG4gICAgICAgIGNvbnN0IHN1aXRlcyA9IHRoaXMuZ2V0T3JkZXJlZFN1aXRlcygpXG5cbiAgICAgICAgZm9yIChjb25zdCBzdWl0ZSBvZiBzdWl0ZXMpIHtcbiAgICAgICAgICAgIC8vIERvbid0IGRvIGFueXRoaW5nIGlmIGEgc3VpdGUgaGFzIG5vIHRlc3RzIG9yIHN1YiBzdWl0ZXNcbiAgICAgICAgICAgIGlmIChzdWl0ZS50ZXN0cy5sZW5ndGggPT09IDAgJiYgc3VpdGUuc3VpdGVzLmxlbmd0aCA9PT0gMCAmJiBzdWl0ZS5ob29rcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBHZXQgdGhlIGluZGVudC9zdGFydGluZyBwb2ludCBmb3IgdGhpcyBzdWl0ZVxuICAgICAgICAgICAgY29uc3Qgc3VpdGVJbmRlbnQgPSB0aGlzLmluZGVudChzdWl0ZS51aWQpXG5cbiAgICAgICAgICAgIC8vIERpc3BsYXkgdGhlIHRpdGxlIG9mIHRoZSBzdWl0ZVxuICAgICAgICAgICAgb3V0cHV0LnB1c2goYCR7c3VpdGVJbmRlbnR9JHtzdWl0ZS50aXRsZX1gKVxuXG4gICAgICAgICAgICBjb25zdCBldmVudHNUb1JlcG9ydCA9IHRoaXMuZ2V0RXZlbnRzVG9SZXBvcnQoc3VpdGUpXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHRlc3Qgb2YgZXZlbnRzVG9SZXBvcnQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXN0X3RpdGxlID0gdGVzdC50aXRsZVxuICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gdGVzdC5zdGF0ZVxuICAgICAgICAgICAgICAgIGNvbnN0IHRlc3RfaW5kZW50ID0gYCR7dGhpcy5kZWZhdWx0VGVzdEluZGVudH0ke3N1aXRlSW5kZW50fWBcblxuICAgICAgICAgICAgICAgIC8vIE91dHB1dCBmb3IgYSBzaW5nbGUgdGVzdFxuICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKGAke3Rlc3RfaW5kZW50fSR7dGhpcy5jaGFsa1t0aGlzLmdldENvbG9yKHN0YXRlKV0odGhpcy5nZXRTeW1ib2woc3RhdGUpKX0gJHt0ZXN0X3RpdGxlfWApXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFB1dCBhIGxpbmUgYnJlYWsgYWZ0ZXIgZWFjaCBzdWl0ZSAob25seSBpZiB0ZXN0cyBleGlzdCBpbiB0aGF0IHN1aXRlKVxuICAgICAgICAgICAgaWYgKGV2ZW50c1RvUmVwb3J0Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKCcnKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG91dHB1dFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgZGlzcGxheSBmb3IgcGFzc2luZywgZmFpbGluZyBhbmQgc2tpcHBlZFxuICAgICAqIEBwYXJhbSAge1N0cmluZ30gZHVyYXRpb24gRHVyYXRpb24gc3RyaW5nXG4gICAgICogQHJldHVybiB7QXJyYXl9IENvdW50IGRpc3BsYXlcbiAgICAgKi9cbiAgICBnZXRDb3VudERpc3BsYXkgKGR1cmF0aW9uKSB7XG4gICAgICAgIGNvbnN0IG91dHB1dCA9IFtdXG5cbiAgICAgICAgLy8gR2V0IHRoZSBwYXNzZXNcbiAgICAgICAgaWYodGhpcy5zdGF0ZUNvdW50cy5wYXNzZWQgPiAwKSB7XG4gICAgICAgICAgICBjb25zdCB0ZXh0ID0gYCR7dGhpcy5zdGF0ZUNvdW50cy5wYXNzZWR9IHBhc3NpbmcgJHtkdXJhdGlvbn1gXG4gICAgICAgICAgICBvdXRwdXQucHVzaCh0aGlzLmNoYWxrW3RoaXMuZ2V0Q29sb3IoJ3Bhc3NlZCcpXSh0ZXh0KSlcbiAgICAgICAgICAgIGR1cmF0aW9uID0gJydcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEdldCB0aGUgZmFpbHVyZXNcbiAgICAgICAgaWYodGhpcy5zdGF0ZUNvdW50cy5mYWlsZWQgPiAwKSB7XG4gICAgICAgICAgICBjb25zdCB0ZXh0ID0gYCR7dGhpcy5zdGF0ZUNvdW50cy5mYWlsZWR9IGZhaWxpbmcgJHtkdXJhdGlvbn1gLnRyaW0oKVxuICAgICAgICAgICAgb3V0cHV0LnB1c2godGhpcy5jaGFsa1t0aGlzLmdldENvbG9yKCdmYWlsZWQnKV0odGV4dCkpXG4gICAgICAgICAgICBkdXJhdGlvbiA9ICcnXG4gICAgICAgIH1cblxuICAgICAgICAvLyBHZXQgdGhlIHNraXBwZWQgdGVzdHNcbiAgICAgICAgaWYodGhpcy5zdGF0ZUNvdW50cy5za2lwcGVkID4gMCkge1xuICAgICAgICAgICAgY29uc3QgdGV4dCA9IGAke3RoaXMuc3RhdGVDb3VudHMuc2tpcHBlZH0gc2tpcHBlZCAke2R1cmF0aW9ufWAudHJpbSgpXG4gICAgICAgICAgICBvdXRwdXQucHVzaCh0aGlzLmNoYWxrW3RoaXMuZ2V0Q29sb3IoJ3NraXBwZWQnKV0odGV4dCkpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3V0cHV0XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGRpc3BsYXkgZm9yIGZhaWxlZCB0ZXN0cywgZS5nLiBzdGFjayB0cmFjZVxuICAgICAqIEByZXR1cm4ge0FycmF5fSBTdGFjayB0cmFjZSBvdXRwdXRcbiAgICAgKi9cbiAgICBnZXRGYWlsdXJlRGlzcGxheSAoKSB7XG4gICAgICAgIGxldCBmYWlsdXJlTGVuZ3RoID0gMFxuICAgICAgICBjb25zdCBvdXRwdXQgPSBbXVxuICAgICAgICBjb25zdCBzdWl0ZXMgPSB0aGlzLmdldE9yZGVyZWRTdWl0ZXMoKVxuXG4gICAgICAgIGZvciAoY29uc3Qgc3VpdGUgb2Ygc3VpdGVzKSB7XG4gICAgICAgICAgICBjb25zdCBzdWl0ZVRpdGxlID0gc3VpdGUudGl0bGVcbiAgICAgICAgICAgIGNvbnN0IGV2ZW50c1RvUmVwb3J0ID0gdGhpcy5nZXRFdmVudHNUb1JlcG9ydChzdWl0ZSlcbiAgICAgICAgICAgIGZvciAoY29uc3QgdGVzdCBvZiBldmVudHNUb1JlcG9ydCkge1xuICAgICAgICAgICAgICAgIGlmKHRlc3Quc3RhdGUgIT09ICdmYWlsZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgdGVzdFRpdGxlID0gdGVzdC50aXRsZVxuXG4gICAgICAgICAgICAgICAgLy8gSWYgd2UgZ2V0IGhlcmUgdGhlbiB0aGVyZSBpcyBhIGZhaWxlZCB0ZXN0XG4gICAgICAgICAgICAgICAgb3V0cHV0LnB1c2goXG4gICAgICAgICAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgICAgICAgICBgJHsrK2ZhaWx1cmVMZW5ndGh9KSAke3N1aXRlVGl0bGV9ICR7dGVzdFRpdGxlfWAsXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbGsucmVkKHRlc3QuZXJyb3IubWVzc2FnZSksXG4gICAgICAgICAgICAgICAgICAgIC4uLnRlc3QuZXJyb3Iuc3RhY2suc3BsaXQoL1xcbi9nKS5tYXAodmFsdWUgPT4gdGhpcy5jaGFsay5ncmF5KHZhbHVlKSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3V0cHV0XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHN1aXRlcyBpbiB0aGUgb3JkZXIgdGhleSB3ZXJlIGNhbGxlZFxuICAgICAqIEByZXR1cm4ge0FycmF5fSBPcmRlcmVkIHN1aXRlc1xuICAgICAqL1xuICAgIGdldE9yZGVyZWRTdWl0ZXMgKCkge1xuICAgICAgICBpZiAodGhpcy5vcmRlcmVkU3VpdGVzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vcmRlcmVkU3VpdGVzXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm9yZGVyZWRTdWl0ZXMgPSBbXVxuICAgICAgICBmb3IgKGNvbnN0IHVpZCBvZiB0aGlzLnN1aXRlVWlkcykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBzdWl0ZSBvZiB0aGlzLnN1aXRlcykge1xuICAgICAgICAgICAgICAgIGlmIChzdWl0ZS51aWQgIT09IHVpZCkge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRoaXMub3JkZXJlZFN1aXRlcy5wdXNoKHN1aXRlKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub3JkZXJlZFN1aXRlc1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluZGVudCBhIHN1aXRlIGJhc2VkIG9uIHdoZXJlIGhvdyBpdCdzIG5lc3RlZFxuICAgICAqIEBwYXJhbSAge1N0cmluZ30gdWlkIFVuaXF1ZSBzdWl0ZSBrZXlcbiAgICAgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICBTcGFjZXMgZm9yIGluZGVudGF0aW9uXG4gICAgICovXG4gICAgaW5kZW50ICh1aWQpIHtcbiAgICAgICAgY29uc3QgaW5kZW50cyA9IHRoaXMuc3VpdGVJbmRlbnRzW3VpZF1cbiAgICAgICAgcmV0dXJuIGluZGVudHMgPT09IDAgPyAnJyA6IEFycmF5KGluZGVudHMpLmpvaW4oJyAgICAnKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBhIHN5bWJvbCBiYXNlZCBvbiBzdGF0ZVxuICAgICAqIEBwYXJhbSAge1N0cmluZ30gc3RhdGUgU3RhdGUgb2YgYSB0ZXN0XG4gICAgICogQHJldHVybiB7U3RyaW5nfSAgICAgICBTeW1ib2wgdG8gZGlzcGxheVxuICAgICAqL1xuICAgIGdldFN5bWJvbCAoc3RhdGUpIHtcbiAgICAgICAgbGV0IHN5bWJvbCA9ICc/JyAvLyBpbiBjYXNlIG9mIGFuIHVua25vd24gc3RhdGVcblxuICAgICAgICBzd2l0Y2ggKHN0YXRlKSB7XG4gICAgICAgIGNhc2UgJ3Bhc3NlZCc6XG4gICAgICAgICAgICBzeW1ib2wgPSAn4pyTJ1xuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAnc2tpcHBlZCc6XG4gICAgICAgICAgICBzeW1ib2wgPSAnLSdcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ2ZhaWxlZCc6XG4gICAgICAgICAgICBzeW1ib2wgPSAn4pyWJ1xuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzeW1ib2xcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSBjb2xvciBiYXNlZCBvbiBhIGdpdmVuIHN0YXRlXG4gICAgICogQHBhcmFtICB7U3RyaW5nfSBzdGF0ZSBUZXN0IHN0YXRlXG4gICAgICogQHJldHVybiB7U3RyaW5nfSAgICAgICBTdGF0ZSBjb2xvclxuICAgICAqL1xuICAgIGdldENvbG9yIChzdGF0ZSkge1xuICAgICAgICAvLyBJbiBjYXNlIG9mIGFuIHVua25vd24gc3RhdGVcbiAgICAgICAgbGV0IGNvbG9yID0gbnVsbFxuXG4gICAgICAgIHN3aXRjaCAoc3RhdGUpIHtcbiAgICAgICAgY2FzZSAncGFzc2VkJzpcbiAgICAgICAgICAgIGNvbG9yID0gJ2dyZWVuJ1xuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAncGVuZGluZyc6XG4gICAgICAgIGNhc2UgJ3NraXBwZWQnOlxuICAgICAgICAgICAgY29sb3IgPSAnY3lhbidcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ2ZhaWxlZCc6XG4gICAgICAgICAgICBjb2xvciA9ICdyZWQnXG4gICAgICAgICAgICBicmVha1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNvbG9yXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGluZm9ybWF0aW9uIGFib3V0IHRoZSBlbnZpcm9tZW50XG4gICAgICogQHBhcmFtICB7T2JqZWN0fSAgY2FwcyAgICBFbnZpcm9tZW50IGRldGFpbHNcbiAgICAgKiBAcGFyYW0gIHtCb29sZWFufSB2ZXJib3NlXG4gICAgICogQHJldHVybiB7U3RyaW5nfSAgICAgICAgICBFbnZpcm9tZW50IHN0cmluZ1xuICAgICAqL1xuICAgIGdldEVudmlyb21lbnRDb21ibyAoY2FwcywgdmVyYm9zZSA9IHRydWUsIGlzTXVsdGlyZW1vdGUgPSBmYWxzZSkge1xuICAgICAgICBjb25zdCBkZXZpY2UgPSBjYXBzLmRldmljZU5hbWVcbiAgICAgICAgY29uc3QgYnJvd3NlciA9IGlzTXVsdGlyZW1vdGUgPyAnTXVsdGlyZW1vdGVCcm93c2VyJyA6IChjYXBzLmJyb3dzZXJOYW1lIHx8IGNhcHMuYnJvd3NlcilcbiAgICAgICAgY29uc3QgdmVyc2lvbiA9IGNhcHMudmVyc2lvbiB8fCBjYXBzLnBsYXRmb3JtVmVyc2lvbiB8fCBjYXBzLmJyb3dzZXJfdmVyc2lvblxuICAgICAgICBjb25zdCBwbGF0Zm9ybSA9IGNhcHMub3MgPyAoY2Fwcy5vcyArICcgJyArIGNhcHMub3NfdmVyc2lvbikgOiAoY2Fwcy5wbGF0Zm9ybSB8fCBjYXBzLnBsYXRmb3JtTmFtZSlcblxuICAgICAgICAvLyBNb2JpbGUgY2FwYWJpbGl0aWVzXG4gICAgICAgIGlmIChkZXZpY2UpIHtcbiAgICAgICAgICAgIGNvbnN0IHByb2dyYW0gPSAoY2Fwcy5hcHAgfHwgJycpLnJlcGxhY2UoJ3NhdWNlLXN0b3JhZ2U6JywgJycpIHx8IGNhcHMuYnJvd3Nlck5hbWVcbiAgICAgICAgICAgIGNvbnN0IGV4ZWN1dGluZyA9IHByb2dyYW0gPyBgZXhlY3V0aW5nICR7cHJvZ3JhbX1gIDogJydcblxuICAgICAgICAgICAgaWYgKCF2ZXJib3NlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGAke2RldmljZX0gJHtwbGF0Zm9ybX0gJHt2ZXJzaW9ufWBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGAke2RldmljZX0gb24gJHtwbGF0Zm9ybX0gJHt2ZXJzaW9ufSAke2V4ZWN1dGluZ31gLnRyaW0oKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF2ZXJib3NlKSB7XG4gICAgICAgICAgICByZXR1cm4gKGJyb3dzZXIgKyAnICcgKyAodmVyc2lvbiB8fCAnJykgKyAnICcgKyAocGxhdGZvcm0gfHwgJycpKS50cmltKClcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBicm93c2VyICsgKHZlcnNpb24gPyBgICh2JHt2ZXJzaW9ufSlgIDogJycpICsgKHBsYXRmb3JtID8gYCBvbiAke3BsYXRmb3JtfWAgOiAnJylcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFNwZWNSZXBvcnRlclxuIl19