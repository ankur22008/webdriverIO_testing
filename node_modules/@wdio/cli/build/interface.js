"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _chalk = _interopRequireDefault(require("chalk"));

var _cliSpinners = _interopRequireDefault(require("cli-spinners"));

var _events = _interopRequireDefault(require("events"));

var _interface = _interopRequireDefault(require("@wdio/interface"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('wdio-cli');
const clockSpinner = _cliSpinners.default['clock'];
const MAX_RUNNING_JOBS_DISPLAY_COUNT = 10;

class WDIOCLInterface extends _events.default {
  constructor(config, specs, totalWorkerCnt) {
    super();
    this.hasAnsiSupport = !!_chalk.default.supportsColor.hasBasic;
    this.specs = specs;
    this.config = config;
    this.totalWorkerCnt = totalWorkerCnt;
    this.sigintTriggered = false;
    this.interface = new _interface.default();
    this.on('job:start', this.addJob.bind(this));
    this.on('job:end', this.clearJob.bind(this));
    this.setup();
  }

  setup() {
    this.clockTimer = 0;
    this.jobs = new Map();
    this.start = Date.now();
    this.result = {
      finished: 0,
      passed: 0,
      failed: 0
    };
    this.messages = {
      /**
       * messages from worker reporters
       */
      reporter: {},

      /**
       * messages from worker itself
       */
      worker: {}
    };
    this.interface.clearBuffer();
  }
  /**
   * add job to interface
   */


  addJob({
    cid,
    caps,
    specs
  }) {
    this.jobs.set(cid, {
      caps,
      specs
    });
    this.updateView();
  }
  /**
   * clear job from interface
   */


  clearJob({
    cid,
    passed
  }) {
    this.jobs.delete(cid);
    this.result.finished++;

    if (passed) {
      this.result.passed++;
    } else {
      this.result.failed++;
    }

    this.updateView(true);
  }
  /**
   * event handler that is triggered when runner sends up events
   */


  onMessage(event) {
    if (event.origin === 'debugger' && event.name === 'start') {
      clearTimeout(this.interval);
      this.interface.clearAll();
      this.interface.inDebugMode = true;
      this.interface.log(_chalk.default.yellow(event.params.introMessage));
    }

    if (event.origin === 'debugger' && event.name === 'stop') {
      this.interface.inDebugMode = false;
      this.sigintTriggered = false;
      return this.updateView();
    }

    if (!event.origin || !this.messages[event.origin]) {
      return log.warn(`Can't identify message from worker: ${JSON.stringify(event)}, ignoring!`);
    }

    if (!this.messages[event.origin][event.name]) {
      this.messages[event.origin][event.name] = [];
    }

    this.messages[event.origin][event.name].push(event.content);
  }

  sigintTrigger() {
    /**
     * allow to exit repl mode via Ctrl+C
     */
    if (this.interface.inDebugMode) {
      return;
    }

    this.sigintTriggered = true;
    this.updateView();
  }

  updateView(wasJobCleared) {
    const totalJobs = this.totalWorkerCnt;
    const pendingJobs = this.totalWorkerCnt - this.jobs.size - this.result.finished;
    const runningJobs = this.jobs.size;
    const isFinished = runningJobs === 0;
    /**
     * check if environment supports ansi and print a limited update if not
     */

    if (!this.hasAnsiSupport && !isFinished) {
      /**
       * only update if a job finishes
       */
      if (!wasJobCleared) {
        return;
      }

      const clockSpinnerSymbol = this.getClockSymbol();
      return this.interface.log(`${clockSpinnerSymbol} ` + `${this.jobs.size} running, ` + `${this.result.passed} passed, ` + `${this.result.failed} failed, ` + `${totalJobs} total ` + `(${Math.round(this.result.finished / totalJobs * 100)}% completed)`);
    }

    this.interface.clearAll();
    this.interface.log();
    /**
     * print reporter output
     */

    for (const [reporterName, messages] of Object.entries(this.messages.reporter)) {
      this.interface.log(_chalk.default.bgYellow.black(`"${reporterName}" Reporter:`));
      this.interface.log(messages.join(''));
      this.interface.log();
    }
    /**
     * print running jobs
     */


    for (const [cid, job] of Array.from(this.jobs.entries()).slice(0, MAX_RUNNING_JOBS_DISPLAY_COUNT)) {
      const filename = job.specs.join(', ').replace(process.cwd(), '');
      this.interface.log(_chalk.default.bgYellow.black(' RUNNING '), cid, 'in', job.caps.browserName, '-', filename);
    }
    /**
     * show number of pending and running jobs
     */


    if (pendingJobs || runningJobs > MAX_RUNNING_JOBS_DISPLAY_COUNT) {
      const logString = [];

      if (runningJobs > MAX_RUNNING_JOBS_DISPLAY_COUNT) {
        logString.push(runningJobs - MAX_RUNNING_JOBS_DISPLAY_COUNT, 'running tests' + (pendingJobs ? ' -' : ''));
      }

      if (pendingJobs) {
        logString.push(pendingJobs, 'pending tests');
      }

      this.interface.log(_chalk.default.yellow('...', ...logString.filter(l => Boolean(l))));
    }
    /**
     * print stdout and stderr from runners
     */


    if (isFinished) {
      /* istanbul ignore else */
      if (this.interface.stdoutBuffer.length) {
        this.interface.log(_chalk.default.bgYellow.black('Stdout:\n') + this.interface.stdoutBuffer.join(''));
      }
      /* istanbul ignore else */


      if (this.interface.stderrBuffer.length) {
        this.interface.log(_chalk.default.bgRed.black('Stderr:\n') + this.interface.stderrBuffer.join(''));
      }
      /* istanbul ignore else */


      if (this.messages.worker.error) {
        this.interface.log(_chalk.default.bgRed.black('Worker Error:\n') + this.messages.worker.error.map(e => e.stack).join('\n') + '\n');
      }
    }
    /**
     * add empty line between "pending tests" and results
     */


    if (this.jobs.size) {
      this.interface.log();
    }

    this.interface.log('Test Suites:\t', _chalk.default.green(this.result.passed, 'passed') + ', ' + (this.result.failed ? _chalk.default.red(this.result.failed, 'failed') + ', ' : '') + totalJobs, 'total', `(${totalJobs ? Math.round(this.result.finished / totalJobs * 100) : 0}% completed)`);
    this.updateClock();

    if (this.sigintTriggered) {
      clearTimeout(this.interval);
      this.interface.log('\n');
      this.interface.log(!isFinished ? 'Ending WebDriver sessions gracefully ...\n' + '(press ctrl+c again to hard kill the runner)' : 'Ended WebDriver sessions gracefully after a SIGINT signal was received!');
    }

    if (isFinished) {
      clearTimeout(this.interval);
      this.interface.log('\n');
    }
  }

  updateClock(interval = 100) {
    const clockSpinnerSymbol = this.getClockSymbol();
    clearTimeout(this.interval);
    this.interface.clearLine();
    this.interface.write('Time:\t\t ' + clockSpinnerSymbol + ' ' + ((Date.now() - this.start) / 1000).toFixed(2) + 's');
    this.interval = setTimeout(() => this.updateClock(interval), interval);
  }

  getClockSymbol() {
    return clockSpinner.frames[this.clockTimer = ++this.clockTimer % clockSpinner.frames.length];
  }

  reset() {
    this.interface.reset();
  }

}

exports.default = WDIOCLInterface;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbnRlcmZhY2UuanMiXSwibmFtZXMiOlsibG9nIiwiY2xvY2tTcGlubmVyIiwiY2xpU3Bpbm5lcnMiLCJNQVhfUlVOTklOR19KT0JTX0RJU1BMQVlfQ09VTlQiLCJXRElPQ0xJbnRlcmZhY2UiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsInNwZWNzIiwidG90YWxXb3JrZXJDbnQiLCJoYXNBbnNpU3VwcG9ydCIsImNoYWxrIiwic3VwcG9ydHNDb2xvciIsImhhc0Jhc2ljIiwic2lnaW50VHJpZ2dlcmVkIiwiaW50ZXJmYWNlIiwiQ0xJbnRlcmZhY2UiLCJvbiIsImFkZEpvYiIsImNsZWFySm9iIiwic2V0dXAiLCJjbG9ja1RpbWVyIiwiam9icyIsIk1hcCIsInN0YXJ0IiwiRGF0ZSIsIm5vdyIsInJlc3VsdCIsImZpbmlzaGVkIiwicGFzc2VkIiwiZmFpbGVkIiwibWVzc2FnZXMiLCJyZXBvcnRlciIsIndvcmtlciIsImNsZWFyQnVmZmVyIiwiY2lkIiwiY2FwcyIsInNldCIsInVwZGF0ZVZpZXciLCJkZWxldGUiLCJvbk1lc3NhZ2UiLCJldmVudCIsIm9yaWdpbiIsIm5hbWUiLCJjbGVhclRpbWVvdXQiLCJpbnRlcnZhbCIsImNsZWFyQWxsIiwiaW5EZWJ1Z01vZGUiLCJ5ZWxsb3ciLCJwYXJhbXMiLCJpbnRyb01lc3NhZ2UiLCJ3YXJuIiwiSlNPTiIsInN0cmluZ2lmeSIsInB1c2giLCJjb250ZW50Iiwic2lnaW50VHJpZ2dlciIsIndhc0pvYkNsZWFyZWQiLCJ0b3RhbEpvYnMiLCJwZW5kaW5nSm9icyIsInNpemUiLCJydW5uaW5nSm9icyIsImlzRmluaXNoZWQiLCJjbG9ja1NwaW5uZXJTeW1ib2wiLCJnZXRDbG9ja1N5bWJvbCIsIk1hdGgiLCJyb3VuZCIsInJlcG9ydGVyTmFtZSIsIk9iamVjdCIsImVudHJpZXMiLCJiZ1llbGxvdyIsImJsYWNrIiwiam9pbiIsImpvYiIsIkFycmF5IiwiZnJvbSIsInNsaWNlIiwiZmlsZW5hbWUiLCJyZXBsYWNlIiwicHJvY2VzcyIsImN3ZCIsImJyb3dzZXJOYW1lIiwibG9nU3RyaW5nIiwiZmlsdGVyIiwibCIsIkJvb2xlYW4iLCJzdGRvdXRCdWZmZXIiLCJsZW5ndGgiLCJzdGRlcnJCdWZmZXIiLCJiZ1JlZCIsImVycm9yIiwibWFwIiwiZSIsInN0YWNrIiwiZ3JlZW4iLCJyZWQiLCJ1cGRhdGVDbG9jayIsImNsZWFyTGluZSIsIndyaXRlIiwidG9GaXhlZCIsInNldFRpbWVvdXQiLCJmcmFtZXMiLCJyZXNldCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxHQUFHLEdBQUcscUJBQU8sVUFBUCxDQUFaO0FBRUEsTUFBTUMsWUFBWSxHQUFHQyxxQkFBWSxPQUFaLENBQXJCO0FBQ0EsTUFBTUMsOEJBQThCLEdBQUcsRUFBdkM7O0FBRWUsTUFBTUMsZUFBTixTQUE4QkMsZUFBOUIsQ0FBMkM7QUFDdERDLEVBQUFBLFdBQVcsQ0FBRUMsTUFBRixFQUFVQyxLQUFWLEVBQWlCQyxjQUFqQixFQUFpQztBQUN4QztBQUNBLFNBQUtDLGNBQUwsR0FBc0IsQ0FBQyxDQUFDQyxlQUFNQyxhQUFOLENBQW9CQyxRQUE1QztBQUNBLFNBQUtMLEtBQUwsR0FBYUEsS0FBYjtBQUNBLFNBQUtELE1BQUwsR0FBY0EsTUFBZDtBQUNBLFNBQUtFLGNBQUwsR0FBc0JBLGNBQXRCO0FBQ0EsU0FBS0ssZUFBTCxHQUF1QixLQUF2QjtBQUVBLFNBQUtDLFNBQUwsR0FBaUIsSUFBSUMsa0JBQUosRUFBakI7QUFDQSxTQUFLQyxFQUFMLENBQVEsV0FBUixFQUF1QixLQUFLQyxNQUE1QixNQUF1QixJQUF2QjtBQUNBLFNBQUtELEVBQUwsQ0FBUSxTQUFSLEVBQXFCLEtBQUtFLFFBQTFCLE1BQXFCLElBQXJCO0FBRUEsU0FBS0MsS0FBTDtBQUNIOztBQUVEQSxFQUFBQSxLQUFLLEdBQUk7QUFDTCxTQUFLQyxVQUFMLEdBQWtCLENBQWxC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QUFLQyxjQUFMLEVBQTNCO0FBRUFwQixJQUFBQSxZQUFZLENBQUMsS0FBS0MsUUFBTixDQUFaO0FBQ0EsU0FBSzlCLFNBQUwsQ0FBZWtGLFNBQWY7QUFDQSxTQUFLbEYsU0FBTCxDQUFlbUYsS0FBZixDQUFxQixlQUFlbkMsa0JBQWYsR0FBb0MsR0FBcEMsR0FBMEMsQ0FBQyxDQUFDdEMsSUFBSSxDQUFDQyxHQUFMLEtBQWEsS0FBS0YsS0FBbkIsSUFBNEIsSUFBN0IsRUFBbUMyRSxPQUFuQyxDQUEyQyxDQUEzQyxDQUExQyxHQUEwRixHQUEvRztBQUNBLFNBQUt0RCxRQUFMLEdBQWdCdUQsVUFBVSxDQUFDLE1BQU0sS0FBS0osV0FBTCxDQUFpQm5ELFFBQWpCLENBQVAsRUFBbUNBLFFBQW5DLENBQTFCO0FBQ0g7O0FBRURtQixFQUFBQSxjQUFjLEdBQUk7QUFDZCxXQUFPL0QsWUFBWSxDQUFDb0csTUFBYixDQUFvQixLQUFLaEYsVUFBTCxHQUFrQixFQUFFLEtBQUtBLFVBQVAsR0FBb0JwQixZQUFZLENBQUNvRyxNQUFiLENBQW9CZCxNQUE5RSxDQUFQO0FBQ0g7O0FBRURlLEVBQUFBLEtBQUssR0FBSTtBQUNMLFNBQUt2RixTQUFMLENBQWV1RixLQUFmO0FBQ0g7O0FBdk9xRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGFsayBmcm9tICdjaGFsaydcbmltcG9ydCBjbGlTcGlubmVycyBmcm9tICdjbGktc3Bpbm5lcnMnXG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJ2V2ZW50cydcbmltcG9ydCBDTEludGVyZmFjZSBmcm9tICdAd2Rpby9pbnRlcmZhY2UnXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcblxuY29uc3QgbG9nID0gbG9nZ2VyKCd3ZGlvLWNsaScpXG5cbmNvbnN0IGNsb2NrU3Bpbm5lciA9IGNsaVNwaW5uZXJzWydjbG9jayddXG5jb25zdCBNQVhfUlVOTklOR19KT0JTX0RJU1BMQVlfQ09VTlQgPSAxMFxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXRElPQ0xJbnRlcmZhY2UgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGNvbnN0cnVjdG9yIChjb25maWcsIHNwZWNzLCB0b3RhbFdvcmtlckNudCkge1xuICAgICAgICBzdXBlcigpXG4gICAgICAgIHRoaXMuaGFzQW5zaVN1cHBvcnQgPSAhIWNoYWxrLnN1cHBvcnRzQ29sb3IuaGFzQmFzaWNcbiAgICAgICAgdGhpcy5zcGVjcyA9IHNwZWNzXG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnXG4gICAgICAgIHRoaXMudG90YWxXb3JrZXJDbnQgPSB0b3RhbFdvcmtlckNudFxuICAgICAgICB0aGlzLnNpZ2ludFRyaWdnZXJlZCA9IGZhbHNlXG5cbiAgICAgICAgdGhpcy5pbnRlcmZhY2UgPSBuZXcgQ0xJbnRlcmZhY2UoKVxuICAgICAgICB0aGlzLm9uKCdqb2I6c3RhcnQnLCA6OnRoaXMuYWRkSm9iKVxuICAgICAgICB0aGlzLm9uKCdqb2I6ZW5kJywgOjp0aGlzLmNsZWFySm9iKVxuXG4gICAgICAgIHRoaXMuc2V0dXAoKVxuICAgIH1cblxuICAgIHNldHVwICgpIHtcbiAgICAgICAgdGhpcy5jbG9ja1RpbWVyID0gMFxuICAgICAgICB0aGlzLmpvYnMgPSBuZXcgTWFwKClcbiAgICAgICAgdGhpcy5zdGFydCA9IERhdGUubm93KClcbiAgICAgICAgdGhpcy5yZXN1bHQgPSB7XG4gICAgICAgICAgICBmaW5pc2hlZDogMCxcbiAgICAgICAgICAgIHBhc3NlZDogMCxcbiAgICAgICAgICAgIGZhaWxlZDogMFxuICAgICAgICB9XG4gICAgICAgIHRoaXMubWVzc2FnZXMgPSB7XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIG1lc3NhZ2VzIGZyb20gd29ya2VyIHJlcG9ydGVyc1xuICAgICAgICAgICAgICovXG4gICAgICAgICAgICByZXBvcnRlcjoge30sXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIG1lc3NhZ2VzIGZyb20gd29ya2VyIGl0c2VsZlxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICB3b3JrZXI6IHt9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pbnRlcmZhY2UuY2xlYXJCdWZmZXIoKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGFkZCBqb2IgdG8gaW50ZXJmYWNlXG4gICAgICovXG4gICAgYWRkSm9iKHsgY2lkLCBjYXBzLCBzcGVjcyB9KSB7XG4gICAgICAgIHRoaXMuam9icy5zZXQoY2lkLCB7IGNhcHMsIHNwZWNzIH0pXG4gICAgICAgIHRoaXMudXBkYXRlVmlldygpXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogY2xlYXIgam9iIGZyb20gaW50ZXJmYWNlXG4gICAgICovXG4gICAgY2xlYXJKb2IgKHsgY2lkLCBwYXNzZWQgfSkge1xuICAgICAgICB0aGlzLmpvYnMuZGVsZXRlKGNpZClcbiAgICAgICAgdGhpcy5yZXN1bHQuZmluaXNoZWQrK1xuXG4gICAgICAgIGlmIChwYXNzZWQpIHtcbiAgICAgICAgICAgIHRoaXMucmVzdWx0LnBhc3NlZCsrXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnJlc3VsdC5mYWlsZWQrK1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy51cGRhdGVWaWV3KHRydWUpXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogZXZlbnQgaGFuZGxlciB0aGF0IGlzIHRyaWdnZXJlZCB3aGVuIHJ1bm5lciBzZW5kcyB1cCBldmVudHNcbiAgICAgKi9cbiAgICBvbk1lc3NhZ2UgKGV2ZW50KSB7XG4gICAgICAgIGlmIChldmVudC5vcmlnaW4gPT09ICdkZWJ1Z2dlcicgJiYgZXZlbnQubmFtZSA9PT0gJ3N0YXJ0Jykge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuaW50ZXJ2YWwpXG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZS5jbGVhckFsbCgpXG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZS5pbkRlYnVnTW9kZSA9IHRydWVcbiAgICAgICAgICAgIHRoaXMuaW50ZXJmYWNlLmxvZyhjaGFsay55ZWxsb3coZXZlbnQucGFyYW1zLmludHJvTWVzc2FnZSkpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXZlbnQub3JpZ2luID09PSAnZGVidWdnZXInICYmIGV2ZW50Lm5hbWUgPT09ICdzdG9wJykge1xuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UuaW5EZWJ1Z01vZGUgPSBmYWxzZVxuICAgICAgICAgICAgdGhpcy5zaWdpbnRUcmlnZ2VyZWQgPSBmYWxzZVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlVmlldygpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWV2ZW50Lm9yaWdpbiB8fCAhdGhpcy5tZXNzYWdlc1tldmVudC5vcmlnaW5dKSB7XG4gICAgICAgICAgICByZXR1cm4gbG9nLndhcm4oYENhbid0IGlkZW50aWZ5IG1lc3NhZ2UgZnJvbSB3b3JrZXI6ICR7SlNPTi5zdHJpbmdpZnkoZXZlbnQpfSwgaWdub3JpbmchYClcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5tZXNzYWdlc1tldmVudC5vcmlnaW5dW2V2ZW50Lm5hbWVdKSB7XG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2VzW2V2ZW50Lm9yaWdpbl1bZXZlbnQubmFtZV0gPSBbXVxuICAgICAgICB9XG4gICAgICAgIHRoaXMubWVzc2FnZXNbZXZlbnQub3JpZ2luXVtldmVudC5uYW1lXS5wdXNoKGV2ZW50LmNvbnRlbnQpXG4gICAgfVxuXG4gICAgc2lnaW50VHJpZ2dlciAoKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBhbGxvdyB0byBleGl0IHJlcGwgbW9kZSB2aWEgQ3RybCtDXG4gICAgICAgICAqL1xuICAgICAgICBpZiAodGhpcy5pbnRlcmZhY2UuaW5EZWJ1Z01vZGUpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zaWdpbnRUcmlnZ2VyZWQgPSB0cnVlXG4gICAgICAgIHRoaXMudXBkYXRlVmlldygpXG4gICAgfVxuXG4gICAgdXBkYXRlVmlldyAod2FzSm9iQ2xlYXJlZCkge1xuICAgICAgICBjb25zdCB0b3RhbEpvYnMgPSB0aGlzLnRvdGFsV29ya2VyQ250XG4gICAgICAgIGNvbnN0IHBlbmRpbmdKb2JzID0gdGhpcy50b3RhbFdvcmtlckNudCAtIHRoaXMuam9icy5zaXplIC0gdGhpcy5yZXN1bHQuZmluaXNoZWRcbiAgICAgICAgY29uc3QgcnVubmluZ0pvYnMgPSB0aGlzLmpvYnMuc2l6ZVxuICAgICAgICBjb25zdCBpc0ZpbmlzaGVkID0gcnVubmluZ0pvYnMgPT09IDBcblxuICAgICAgICAvKipcbiAgICAgICAgICogY2hlY2sgaWYgZW52aXJvbm1lbnQgc3VwcG9ydHMgYW5zaSBhbmQgcHJpbnQgYSBsaW1pdGVkIHVwZGF0ZSBpZiBub3RcbiAgICAgICAgICovXG4gICAgICAgIGlmICghdGhpcy5oYXNBbnNpU3VwcG9ydCAmJiAhaXNGaW5pc2hlZCkge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBvbmx5IHVwZGF0ZSBpZiBhIGpvYiBmaW5pc2hlc1xuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBpZiAoIXdhc0pvYkNsZWFyZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgY2xvY2tTcGlubmVyU3ltYm9sID0gdGhpcy5nZXRDbG9ja1N5bWJvbCgpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pbnRlcmZhY2UubG9nKFxuICAgICAgICAgICAgICAgIGAke2Nsb2NrU3Bpbm5lclN5bWJvbH0gYCArXG4gICAgICAgICAgICAgICAgYCR7dGhpcy5qb2JzLnNpemV9IHJ1bm5pbmcsIGAgK1xuICAgICAgICAgICAgICAgIGAke3RoaXMucmVzdWx0LnBhc3NlZH0gcGFzc2VkLCBgICtcbiAgICAgICAgICAgICAgICBgJHt0aGlzLnJlc3VsdC5mYWlsZWR9IGZhaWxlZCwgYCArXG4gICAgICAgICAgICAgICAgYCR7dG90YWxKb2JzfSB0b3RhbCBgICtcbiAgICAgICAgICAgICAgICBgKCR7TWF0aC5yb3VuZCgodGhpcy5yZXN1bHQuZmluaXNoZWQgLyB0b3RhbEpvYnMpICogMTAwKX0lIGNvbXBsZXRlZClgKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5pbnRlcmZhY2UuY2xlYXJBbGwoKVxuICAgICAgICB0aGlzLmludGVyZmFjZS5sb2coKVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBwcmludCByZXBvcnRlciBvdXRwdXRcbiAgICAgICAgICovXG4gICAgICAgIGZvciAoY29uc3QgW3JlcG9ydGVyTmFtZSwgbWVzc2FnZXNdIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMubWVzc2FnZXMucmVwb3J0ZXIpKSB7XG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZS5sb2coY2hhbGsuYmdZZWxsb3cuYmxhY2soYFwiJHtyZXBvcnRlck5hbWV9XCIgUmVwb3J0ZXI6YCkpXG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZS5sb2cobWVzc2FnZXMuam9pbignJykpXG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZS5sb2coKVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHByaW50IHJ1bm5pbmcgam9ic1xuICAgICAgICAgKi9cbiAgICAgICAgZm9yIChjb25zdCBbY2lkLCBqb2JdIG9mIEFycmF5LmZyb20odGhpcy5qb2JzLmVudHJpZXMoKSkuc2xpY2UoMCwgTUFYX1JVTk5JTkdfSk9CU19ESVNQTEFZX0NPVU5UKSkge1xuICAgICAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBqb2Iuc3BlY3Muam9pbignLCAnKS5yZXBsYWNlKHByb2Nlc3MuY3dkKCksICcnKVxuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKGNoYWxrLmJnWWVsbG93LmJsYWNrKCcgUlVOTklORyAnKSwgY2lkLCAnaW4nLCBqb2IuY2Fwcy5icm93c2VyTmFtZSwgJy0nLCBmaWxlbmFtZSlcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBzaG93IG51bWJlciBvZiBwZW5kaW5nIGFuZCBydW5uaW5nIGpvYnNcbiAgICAgICAgICovXG4gICAgICAgIGlmIChwZW5kaW5nSm9icyB8fCBydW5uaW5nSm9icyA+IE1BWF9SVU5OSU5HX0pPQlNfRElTUExBWV9DT1VOVCkge1xuICAgICAgICAgICAgY29uc3QgbG9nU3RyaW5nID0gW11cbiAgICAgICAgICAgIGlmIChydW5uaW5nSm9icyA+IE1BWF9SVU5OSU5HX0pPQlNfRElTUExBWV9DT1VOVCkge1xuICAgICAgICAgICAgICAgIGxvZ1N0cmluZy5wdXNoKFxuICAgICAgICAgICAgICAgICAgICBydW5uaW5nSm9icyAtIE1BWF9SVU5OSU5HX0pPQlNfRElTUExBWV9DT1VOVCxcbiAgICAgICAgICAgICAgICAgICAgJ3J1bm5pbmcgdGVzdHMnICsgKHBlbmRpbmdKb2JzID8gJyAtJyA6ICcnKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwZW5kaW5nSm9icykge1xuICAgICAgICAgICAgICAgIGxvZ1N0cmluZy5wdXNoKHBlbmRpbmdKb2JzLCAncGVuZGluZyB0ZXN0cycpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZS5sb2coY2hhbGsueWVsbG93KCcuLi4nLCAuLi5sb2dTdHJpbmcuZmlsdGVyKGwgPT4gQm9vbGVhbihsKSkpKVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHByaW50IHN0ZG91dCBhbmQgc3RkZXJyIGZyb20gcnVubmVyc1xuICAgICAgICAgKi9cbiAgICAgICAgaWYgKGlzRmluaXNoZWQpIHtcbiAgICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovXG4gICAgICAgICAgICBpZiAodGhpcy5pbnRlcmZhY2Uuc3Rkb3V0QnVmZmVyLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRoaXMuaW50ZXJmYWNlLmxvZyhjaGFsay5iZ1llbGxvdy5ibGFjaygnU3Rkb3V0OlxcbicpICsgdGhpcy5pbnRlcmZhY2Uuc3Rkb3V0QnVmZmVyLmpvaW4oJycpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi9cbiAgICAgICAgICAgIGlmICh0aGlzLmludGVyZmFjZS5zdGRlcnJCdWZmZXIubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKGNoYWxrLmJnUmVkLmJsYWNrKCdTdGRlcnI6XFxuJykgKyB0aGlzLmludGVyZmFjZS5zdGRlcnJCdWZmZXIuam9pbignJykpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqL1xuICAgICAgICAgICAgaWYgKHRoaXMubWVzc2FnZXMud29ya2VyLmVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKGNoYWxrLmJnUmVkLmJsYWNrKCdXb3JrZXIgRXJyb3I6XFxuJykgKyB0aGlzLm1lc3NhZ2VzLndvcmtlci5lcnJvci5tYXAoXG4gICAgICAgICAgICAgICAgICAgIChlKSA9PiBlLnN0YWNrXG4gICAgICAgICAgICAgICAgKS5qb2luKCdcXG4nKSArICdcXG4nKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGFkZCBlbXB0eSBsaW5lIGJldHdlZW4gXCJwZW5kaW5nIHRlc3RzXCIgYW5kIHJlc3VsdHNcbiAgICAgICAgICovXG4gICAgICAgIGlmICh0aGlzLmpvYnMuc2l6ZSkge1xuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2UubG9nKClcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuaW50ZXJmYWNlLmxvZyhcbiAgICAgICAgICAgICdUZXN0IFN1aXRlczpcXHQnLCBjaGFsay5ncmVlbih0aGlzLnJlc3VsdC5wYXNzZWQsICdwYXNzZWQnKSArICcsICcgK1xuICAgICAgICAgICAgKHRoaXMucmVzdWx0LmZhaWxlZCA/IGNoYWxrLnJlZCh0aGlzLnJlc3VsdC5mYWlsZWQsICdmYWlsZWQnKSArICcsICcgOiAnJykgK1xuICAgICAgICAgICAgdG90YWxKb2JzLCAndG90YWwnLFxuICAgICAgICAgICAgYCgke3RvdGFsSm9icyA/IE1hdGgucm91bmQoKHRoaXMucmVzdWx0LmZpbmlzaGVkIC8gdG90YWxKb2JzKSAqIDEwMCkgOiAwfSUgY29tcGxldGVkKWBcbiAgICAgICAgKVxuXG4gICAgICAgIHRoaXMudXBkYXRlQ2xvY2soKVxuXG4gICAgICAgIGlmICh0aGlzLnNpZ2ludFRyaWdnZXJlZCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuaW50ZXJ2YWwpXG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZS5sb2coJ1xcbicpXG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZS5sb2coIWlzRmluaXNoZWRcbiAgICAgICAgICAgICAgICA/ICdFbmRpbmcgV2ViRHJpdmVyIHNlc3Npb25zIGdyYWNlZnVsbHkgLi4uXFxuJyArXG4gICAgICAgICAgICAgICAgICAnKHByZXNzIGN0cmwrYyBhZ2FpbiB0byBoYXJkIGtpbGwgdGhlIHJ1bm5lciknXG4gICAgICAgICAgICAgICAgOiAnRW5kZWQgV2ViRHJpdmVyIHNlc3Npb25zIGdyYWNlZnVsbHkgYWZ0ZXIgYSBTSUdJTlQgc2lnbmFsIHdhcyByZWNlaXZlZCEnXG4gICAgICAgICAgICApXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaXNGaW5pc2hlZCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuaW50ZXJ2YWwpXG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZS5sb2coJ1xcbicpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB1cGRhdGVDbG9jayAoaW50ZXJ2YWwgPSAxMDApIHtcbiAgICAgICAgY29uc3QgY2xvY2tTcGlubmVyU3ltYm9sID0gdGhpcy5nZXRDbG9ja1N5bWJvbCgpXG5cbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuaW50ZXJ2YWwpXG4gICAgICAgIHRoaXMuaW50ZXJmYWNlLmNsZWFyTGluZSgpXG4gICAgICAgIHRoaXMuaW50ZXJmYWNlLndyaXRlKCdUaW1lOlxcdFxcdCAnICsgY2xvY2tTcGlubmVyU3ltYm9sICsgJyAnICsgKChEYXRlLm5vdygpIC0gdGhpcy5zdGFydCkgLyAxMDAwKS50b0ZpeGVkKDIpICsgJ3MnKVxuICAgICAgICB0aGlzLmludGVydmFsID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZUNsb2NrKGludGVydmFsKSwgaW50ZXJ2YWwpXG4gICAgfVxuXG4gICAgZ2V0Q2xvY2tTeW1ib2wgKCkge1xuICAgICAgICByZXR1cm4gY2xvY2tTcGlubmVyLmZyYW1lc1t0aGlzLmNsb2NrVGltZXIgPSArK3RoaXMuY2xvY2tUaW1lciAlIGNsb2NrU3Bpbm5lci5mcmFtZXMubGVuZ3RoXVxuICAgIH1cblxuICAgIHJlc2V0ICgpIHtcbiAgICAgICAgdGhpcy5pbnRlcmZhY2UucmVzZXQoKVxuICAgIH1cbn1cbiJdfQ==